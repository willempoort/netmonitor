<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NetMonitor Chat - MCP Interface</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <style>
        [x-cloak] { display: none !important; }

        .message-user {
            background: #3b82f6;
            color: white;
        }

        .message-assistant {
            background: #f3f4f6;
            color: #1f2937;
        }

        .tool-call {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
        }

        .tool-result {
            background: #dbeafe;
            border-left: 4px solid #3b82f6;
        }

        /* Scrollbar styling */
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Typing indicator */
        .typing-indicator span {
            animation: blink 1.4s infinite;
            animation-fill-mode: both;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes blink {
            0%, 80%, 100% { opacity: 0; }
            40% { opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col">
    <div x-data="chatApp()" x-init="init()" class="flex flex-col h-screen">
        <!-- Header -->
        <header class="bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg">
            <div class="container mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <!-- NetMonitor Logo -->
                        <img src="/static/logo.png" alt="NetMonitor" class="h-12 w-auto">
                        <div>
                            <h1 class="text-2xl font-bold">NetMonitor Chat</h1>
                            <p class="text-blue-100 text-sm">On-Premise AI met MCP Security Tools</p>
                        </div>
                    </div>

                    <!-- Status Indicators -->
                    <div class="flex items-center space-x-4">
                        <!-- LLM Provider Status -->
                        <div class="flex items-center space-x-2">
                            <div :class="health.ollama === 'connected' ? 'bg-green-400' : 'bg-red-400'"
                                 class="w-3 h-3 rounded-full"></div>
                            <span class="text-sm" x-text="llmProvider === 'lmstudio' ? 'LM Studio' : 'Ollama'"></span>
                        </div>

                        <!-- MCP Status -->
                        <div class="flex items-center space-x-2">
                            <div :class="health.mcp === 'connected' ? 'bg-green-400' : 'bg-red-400'"
                                 class="w-3 h-3 rounded-full"></div>
                            <span class="text-sm" x-text="selectedMcpConfig && selectedMcpConfig !== '__custom__' ? selectedMcpConfig : 'MCP'"></span>
                        </div>

                        <!-- Tools Count -->
                        <div class="text-sm bg-blue-500 px-3 py-1 rounded-full">
                            <span x-text="toolsCount"></span> tools
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="flex-1 container mx-auto px-4 py-6 flex gap-6 overflow-hidden">
            <!-- Sidebar -->
            <aside class="w-80 bg-white rounded-lg shadow-lg p-6 overflow-y-auto">
                <h2 class="text-lg font-semibold mb-4 text-gray-800">Instellingen</h2>

                <!-- Model Selection -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Model
                    </label>
                    <select x-model="selectedModel"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Laden...</option>
                        <template x-for="model in models" :key="model.name">
                            <option :value="model.name" x-text="model.name"></option>
                        </template>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">
                        Aanbevolen: llama3.1:8b of qwen2.5-coder:14b
                    </p>
                </div>

                <!-- Temperature Slider -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Temperature: <span x-text="temperature"></span>
                    </label>
                    <input type="range"
                           x-model.number="temperature"
                           min="0"
                           max="1"
                           step="0.1"
                           class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span>Precies</span>
                        <span>Creatief</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">
                        0.0 = geen hallucinaties, 0.3 = balans, 0.7 = creatief
                    </p>
                </div>

                <!-- Server Configuration -->
                <div class="mb-6 border-t pt-4">
                    <button @click="showConfig = !showConfig"
                            class="w-full flex items-center justify-between text-sm font-medium text-gray-700 mb-2 hover:text-gray-900">
                        <span>‚öôÔ∏è Server Configuratie</span>
                        <svg :class="showConfig ? 'rotate-180' : ''" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div x-show="showConfig"
                         x-transition
                         class="space-y-4">
                        <!-- LLM Provider -->
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">LLM Provider</label>
                            <select x-model="llmProvider"
                                    class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                                <option value="ollama">Ollama</option>
                                <option value="lmstudio">LM Studio</option>
                            </select>
                        </div>

                        <!-- Ollama URL -->
                        <div x-show="llmProvider === 'ollama'">
                            <label class="block text-xs font-medium text-gray-700 mb-1">Ollama URL</label>
                            <input type="text"
                                   x-model="ollamaUrl"
                                   placeholder="http://localhost:11434"
                                   class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                        </div>

                        <!-- LM Studio URL -->
                        <div x-show="llmProvider === 'lmstudio'">
                            <label class="block text-xs font-medium text-gray-700 mb-1">LM Studio URL</label>
                            <input type="text"
                                   x-model="lmstudioUrl"
                                   placeholder="http://localhost:1234"
                                   class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                        </div>

                        <!-- Force Tools for LM Studio -->
                        <div x-show="llmProvider === 'lmstudio'" class="bg-yellow-50 border border-yellow-200 rounded p-2">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox"
                                       x-model="forceToolsLMStudio"
                                       class="mr-2 h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                <div>
                                    <span class="text-xs font-medium text-gray-700">üîß Force Tool Calling (Experimenteel)</span>
                                    <p class="text-xs text-gray-600 mt-0.5">Alleen voor modellen die function calling ondersteunen. Kan 400 errors geven als model dit niet ondersteunt.</p>
                                </div>
                            </label>
                        </div>

                        <!-- MCP Server Selection -->
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">MCP Server</label>
                            <select x-model="selectedMcpConfig"
                                    class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                                <template x-for="config in mcpConfigs" :key="config.name">
                                    <option :value="config.name">
                                        <span x-text="config.name"></span>
                                        <span x-show="config.has_token"> üîë</span>
                                    </option>
                                </template>
                                <option value="__custom__">‚öôÔ∏è Custom...</option>
                            </select>
                            <template x-if="selectedMcpConfig && selectedMcpConfig !== '__custom__'">
                                <p class="text-xs text-gray-500 mt-1" x-text="mcpConfigs.find(c => c.name === selectedMcpConfig)?.url || ''"></p>
                            </template>
                        </div>

                        <!-- Custom MCP Config (only shown when custom selected) -->
                        <template x-if="selectedMcpConfig === '__custom__' || mcpConfigs.length === 0">
                            <div class="space-y-3 border-l-2 border-gray-200 pl-3">
                                <!-- MCP Server URL -->
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">MCP Server URL</label>
                                    <input type="text"
                                           x-model="mcpServerUrl"
                                           placeholder="https://soc.poort.net/mcp"
                                           class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                                </div>

                                <!-- MCP Auth Token -->
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">MCP Auth Token</label>
                                    <input type="password"
                                           x-model="mcpAuthToken"
                                           placeholder="Token (optioneel)"
                                           class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                        </template>

                        <!-- System Prompt -->
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">System Prompt</label>
                            <textarea
                                   x-model="systemPrompt"
                                   rows="3"
                                   placeholder="Je bent een security expert..."
                                   class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"></textarea>
                            <p class="text-xs text-gray-500 mt-1">Instructies voor de AI over hoe te antwoorden</p>
                        </div>

                        <!-- Apply Button -->
                        <button @click="applyConfig()"
                                class="w-full bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium py-2 px-3 rounded transition-colors">
                            ‚úì Configuratie Toepassen
                        </button>
                    </div>
                </div>

                <!-- Available Tools -->
                <div class="mb-6">
                    <button @click="showTools = !showTools"
                            class="w-full flex items-center justify-between text-sm font-medium text-gray-700 mb-2 hover:text-gray-900">
                        <span>Beschikbare Tools (<span x-text="toolsCount"></span>)</span>
                        <svg :class="showTools ? 'rotate-180' : ''" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div x-show="showTools"
                         x-transition:enter="transition ease-out duration-200"
                         x-transition:enter-start="opacity-0 transform scale-95"
                         x-transition:enter-end="opacity-100 transform scale-100"
                         x-transition:leave="transition ease-in duration-150"
                         x-transition:leave-start="opacity-100 transform scale-100"
                         x-transition:leave-end="opacity-0 transform scale-95"
                         class="bg-gray-50 rounded-lg p-3 max-h-64 overflow-y-auto">
                        <template x-if="tools.length === 0">
                            <p class="text-sm text-gray-500">Laden...</p>
                        </template>
                        <template x-for="tool in tools" :key="tool.name">
                            <div class="text-xs text-gray-700 py-1 border-b border-gray-200 last:border-0">
                                <div class="font-mono font-semibold" x-text="tool.name"></div>
                                <div class="text-gray-600 mt-0.5" x-text="tool.description"></div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Debug Mode Toggle -->
                <div class="mb-6">
                    <label class="flex items-center justify-between cursor-pointer">
                        <span class="text-sm font-medium text-gray-700">Debug Mode</span>
                        <div class="relative">
                            <input type="checkbox"
                                   x-model="debugMode"
                                   class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </div>
                    </label>
                    <p class="text-xs text-gray-500 mt-1">
                        Toon tool aanroepen & resultaten
                    </p>
                </div>

                <!-- Clear Chat Button -->
                <button @click="clearChat()"
                        class="w-full bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                    üóëÔ∏è Wis Chat
                </button>
            </aside>

            <!-- Chat Area -->
            <main class="flex-1 bg-white rounded-lg shadow-lg flex flex-col overflow-hidden">
                <!-- Messages -->
                <div class="flex-1 overflow-y-auto p-6 space-y-4 chat-messages"
                     x-ref="messagesContainer">

                    <!-- Welcome Message -->
                    <template x-if="messages.length === 0">
                        <div class="text-center text-gray-500 mt-20">
                            <div class="text-6xl mb-4">üõ°Ô∏è</div>
                            <h2 class="text-2xl font-bold text-gray-700 mb-2">Welkom bij NetMonitor Chat</h2>
                            <p class="text-gray-600 mb-4">Stel vragen over je netwerk security</p>
                            <div class="text-left max-w-md mx-auto bg-blue-50 rounded-lg p-4">
                                <p class="text-sm text-gray-700 font-medium mb-2">Voorbeeldvragen:</p>
                                <ul class="text-sm text-gray-600 space-y-1">
                                    <li>‚Ä¢ Laat recente bedreigingen zien</li>
                                    <li>‚Ä¢ Analyseer IP 10.100.0.4</li>
                                    <li>‚Ä¢ Welke tools zijn beschikbaar?</li>
                                    <li>‚Ä¢ Toon actieve sensors</li>
                                </ul>
                            </div>
                        </div>
                    </template>

                    <!-- Message List -->
                    <template x-for="(msg, index) in messages" :key="index">
                        <div>
                            <!-- User Message -->
                            <template x-if="msg.role === 'user'">
                                <div class="flex justify-end">
                                    <div class="message-user rounded-lg px-4 py-3 max-w-2xl">
                                        <p class="text-sm whitespace-pre-wrap" x-text="msg.content"></p>
                                    </div>
                                </div>
                            </template>

                            <!-- Assistant Message -->
                            <template x-if="msg.role === 'assistant'">
                                <div class="flex justify-start">
                                    <div class="message-assistant rounded-lg px-4 py-3 max-w-2xl">
                                        <p class="text-sm whitespace-pre-wrap" x-text="msg.content"></p>
                                    </div>
                                </div>
                            </template>

                            <!-- Tool Call (only shown in debug mode) -->
                            <template x-if="msg.role === 'tool_call' && debugMode">
                                <div class="flex justify-start">
                                    <div class="tool-call rounded-lg px-4 py-3 max-w-2xl">
                                        <p class="text-xs font-semibold text-amber-800 mb-1">üîß Tool Aanroep</p>
                                        <p class="text-sm font-mono text-amber-900">
                                            <span x-text="msg.tool"></span>(<span x-text="JSON.stringify(msg.args)"></span>)
                                        </p>
                                    </div>
                                </div>
                            </template>

                            <!-- Tool Result (only shown in debug mode) -->
                            <template x-if="msg.role === 'tool_result' && debugMode">
                                <div class="flex justify-start">
                                    <div class="tool-result rounded-lg px-4 py-3 max-w-2xl">
                                        <p class="text-xs font-semibold text-blue-800 mb-1">‚úì Tool Resultaat</p>
                                        <pre class="text-xs font-mono text-blue-900 whitespace-pre-wrap"
                                             x-text="JSON.stringify(msg.result, null, 2)"></pre>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>

                    <!-- Typing Indicator -->
                    <template x-if="isTyping">
                        <div class="flex justify-start">
                            <div class="message-assistant rounded-lg px-4 py-3">
                                <div class="typing-indicator flex space-x-1">
                                    <span class="w-2 h-2 bg-gray-500 rounded-full"></span>
                                    <span class="w-2 h-2 bg-gray-500 rounded-full"></span>
                                    <span class="w-2 h-2 bg-gray-500 rounded-full"></span>
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- Error Message -->
                    <template x-if="error">
                        <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded">
                            <p class="text-sm text-red-700">
                                <span class="font-semibold">Fout:</span> <span x-text="error"></span>
                            </p>
                        </div>
                    </template>
                </div>

                <!-- Input Area -->
                <div class="border-t border-gray-200 p-4">
                    <form @submit.prevent="sendMessage()" class="flex gap-2">
                        <input type="text"
                               x-model="inputMessage"
                               :disabled="isTyping || !selectedModel"
                               placeholder="Type een vraag..."
                               class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:bg-gray-100 disabled:cursor-not-allowed">
                        <button type="submit"
                                :disabled="isTyping || !inputMessage.trim() || !selectedModel"
                                class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed text-white font-medium px-6 py-3 rounded-lg transition-colors">
                            <span x-show="!isTyping">Verstuur</span>
                            <span x-show="isTyping">...</span>
                        </button>
                    </form>
                    <p class="text-xs text-gray-500 mt-2" x-show="!selectedModel">
                        ‚ö†Ô∏è Selecteer eerst een model
                    </p>
                </div>
            </main>
        </div>
    </div>

    <script>
        function chatApp() {
            return {
                // State
                messages: [],
                inputMessage: '',
                isTyping: false,
                error: null,
                debugMode: false,  // Show tool calls/results only when enabled
                showTools: false,  // Tools section collapsed by default
                showConfig: false,  // Configuration section collapsed by default

                // Settings
                selectedModel: '',
                temperature: 0.3,
                models: [],
                tools: [],
                toolsCount: 0,
                health: {
                    ollama: 'disconnected',
                    mcp: 'disconnected'
                },

                // Configuration
                llmProvider: 'ollama',  // 'ollama' or 'lmstudio'
                ollamaUrl: 'http://localhost:11434',
                lmstudioUrl: 'http://localhost:1234',
                mcpConfigs: [],  // Available MCP configurations from server
                selectedMcpConfig: '',  // Selected config name (empty = custom)
                mcpServerUrl: 'https://soc.poort.net/mcp',
                mcpAuthToken: '',
                systemPrompt: 'Je bent een security expert die helpt met NetMonitor. Gebruik de beschikbare tools om actuele informatie op te halen. Geef altijd duidelijke, Nederlandse antwoorden.',
                forceToolsLMStudio: false,  // Force function calling for LM Studio (experimental)

                // WebSocket
                ws: null,
                currentAssistantMessage: '',

                // Initialize
                async init() {
                    // Load configuration FIRST before loading models/tools
                    const savedLlmProvider = localStorage.getItem('netmonitor-chat-llm-provider');
                    const savedOllamaUrl = localStorage.getItem('netmonitor-chat-ollama-url');
                    const savedLmstudioUrl = localStorage.getItem('netmonitor-chat-lmstudio-url');
                    const savedMcpConfig = localStorage.getItem('netmonitor-chat-mcp-config');
                    const savedMcpUrl = localStorage.getItem('netmonitor-chat-mcp-url');
                    const savedMcpToken = localStorage.getItem('netmonitor-chat-mcp-token');
                    const savedSystemPrompt = localStorage.getItem('netmonitor-chat-system-prompt');
                    const savedForceTools = localStorage.getItem('netmonitor-chat-force-tools-lmstudio');

                    if (savedLlmProvider) this.llmProvider = savedLlmProvider;
                    if (savedOllamaUrl) this.ollamaUrl = savedOllamaUrl;
                    if (savedLmstudioUrl) this.lmstudioUrl = savedLmstudioUrl;
                    if (savedMcpConfig) this.selectedMcpConfig = savedMcpConfig;
                    if (savedMcpUrl) this.mcpServerUrl = savedMcpUrl;
                    if (savedMcpToken) this.mcpAuthToken = savedMcpToken;
                    if (savedSystemPrompt) this.systemPrompt = savedSystemPrompt;
                    if (savedForceTools !== null) this.forceToolsLMStudio = savedForceTools === 'true';

                    // Load MCP configurations from server
                    await this.loadMcpConfigs();

                    // NOW load models/tools with the configured provider
                    await this.loadModels();
                    await this.loadTools();
                    await this.checkHealth();

                    // Select model: localStorage > qwen2.5-coder:14b > qwen > first
                    const savedModel = localStorage.getItem('netmonitor-chat-model');
                    if (savedModel && this.models.find(m => m.name === savedModel)) {
                        this.selectedModel = savedModel;
                    } else if (this.models.length > 0) {
                        // Prefer qwen2.5-coder:14b
                        const qwen14b = this.models.find(m => m.name === 'qwen2.5-coder:14b');
                        if (qwen14b) {
                            this.selectedModel = qwen14b.name;
                        } else {
                            // Fallback to any qwen model
                            const anyQwen = this.models.find(m => m.name.includes('qwen'));
                            if (anyQwen) {
                                this.selectedModel = anyQwen.name;
                            } else {
                                // Last resort: first model
                                this.selectedModel = this.models[0].name;
                            }
                        }
                    }

                    // Watch for model changes and save to localStorage
                    this.$watch('selectedModel', (value) => {
                        if (value) {
                            localStorage.setItem('netmonitor-chat-model', value);
                        }
                    });

                    // Watch for debugMode changes and save to localStorage
                    this.$watch('debugMode', (value) => {
                        localStorage.setItem('netmonitor-chat-debug', value);
                    });

                    // Load saved debugMode
                    const savedDebugMode = localStorage.getItem('netmonitor-chat-debug');
                    if (savedDebugMode !== null) {
                        this.debugMode = savedDebugMode === 'true';
                    }

                    // Watch configuration changes and save to localStorage
                    this.$watch('llmProvider', (value) => localStorage.setItem('netmonitor-chat-llm-provider', value));
                    this.$watch('ollamaUrl', (value) => localStorage.setItem('netmonitor-chat-ollama-url', value));
                    this.$watch('lmstudioUrl', (value) => localStorage.setItem('netmonitor-chat-lmstudio-url', value));
                    this.$watch('selectedMcpConfig', (value) => localStorage.setItem('netmonitor-chat-mcp-config', value));
                    this.$watch('mcpServerUrl', (value) => localStorage.setItem('netmonitor-chat-mcp-url', value));
                    this.$watch('mcpAuthToken', (value) => localStorage.setItem('netmonitor-chat-mcp-token', value));
                    this.$watch('systemPrompt', (value) => localStorage.setItem('netmonitor-chat-system-prompt', value));
                    this.$watch('forceToolsLMStudio', (value) => localStorage.setItem('netmonitor-chat-force-tools-lmstudio', value));
                },

                // Load available MCP configurations
                async loadMcpConfigs() {
                    try {
                        const response = await fetch('/api/mcp-configs');
                        const data = await response.json();
                        this.mcpConfigs = data.configs || [];
                        console.log('[MCP] Loaded configs:', this.mcpConfigs.map(c => c.name));

                        if (this.mcpConfigs.length > 0) {
                            // If no selection yet, select the default
                            if (!this.selectedMcpConfig) {
                                this.selectedMcpConfig = data.default || this.mcpConfigs[0].name;
                            }
                            // If selected config not found in list, switch to custom
                            else if (this.selectedMcpConfig !== '__custom__' &&
                                     !this.mcpConfigs.find(c => c.name === this.selectedMcpConfig)) {
                                console.warn('[MCP] Selected config not found:', this.selectedMcpConfig, '- switching to custom');
                                this.selectedMcpConfig = '__custom__';
                            }
                        } else {
                            // No configs available - force custom mode
                            console.log('[MCP] No configs available, using custom mode');
                            this.selectedMcpConfig = '__custom__';
                        }
                    } catch (err) {
                        console.error('Error loading MCP configs:', err);
                        this.selectedMcpConfig = '__custom__';
                    }
                },

                // Get current MCP config (selected or custom)
                getCurrentMcpConfig() {
                    if (this.selectedMcpConfig && this.selectedMcpConfig !== '__custom__') {
                        const config = this.mcpConfigs.find(c => c.name === this.selectedMcpConfig);
                        if (config) {
                            return { name: config.name, url: config.url, useConfigName: true };
                        }
                    }
                    return { url: this.mcpServerUrl, token: this.mcpAuthToken, useConfigName: false };
                },

                // Apply configuration
                async applyConfig() {
                    this.error = null;
                    // Reload models and tools with new configuration
                    await this.loadModels();
                    await this.loadTools();
                    await this.checkHealth();
                    alert('Configuratie toegepast! Modellen en tools zijn opnieuw geladen.');
                },

                // Load available models
                async loadModels() {
                    try {
                        const llmUrl = this.llmProvider === 'lmstudio' ? this.lmstudioUrl : this.ollamaUrl;
                        const response = await fetch('/api/models', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                provider: this.llmProvider,
                                url: llmUrl
                            })
                        });
                        const data = await response.json();
                        this.models = data.models;
                    } catch (err) {
                        console.error('Error loading models:', err);
                        this.error = 'Kon modellen niet laden';
                    }
                },

                // Load available tools
                async loadTools() {
                    try {
                        const mcpConfig = this.getCurrentMcpConfig();
                        const body = mcpConfig.useConfigName
                            ? { config_name: mcpConfig.name }
                            : { url: mcpConfig.url, token: mcpConfig.token };

                        const response = await fetch('/api/tools', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(body)
                        });
                        const data = await response.json();
                        this.tools = data.tools;
                        this.toolsCount = data.count;
                    } catch (err) {
                        console.error('Error loading tools:', err);
                        this.error = 'Kon tools niet laden';
                    }
                },

                // Check health status
                async checkHealth() {
                    try {
                        const llmUrl = this.llmProvider === 'lmstudio' ? this.lmstudioUrl : this.ollamaUrl;
                        const mcpConfig = this.getCurrentMcpConfig();

                        const body = {
                            llm_provider: this.llmProvider,
                            llm_url: llmUrl
                        };

                        if (mcpConfig.useConfigName) {
                            body.mcp_config_name = mcpConfig.name;
                        } else {
                            body.mcp_url = mcpConfig.url;
                            body.mcp_token = mcpConfig.token;
                        }

                        const response = await fetch('/api/health', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(body)
                        });
                        const data = await response.json();
                        this.health.ollama = data.ollama;
                        this.health.mcp = data.mcp;
                    } catch (err) {
                        console.error('Error checking health:', err);
                    }
                },

                // Send message
                async sendMessage() {
                    if (!this.inputMessage.trim() || this.isTyping || !this.selectedModel) {
                        return;
                    }

                    const userMessage = this.inputMessage.trim();
                    this.inputMessage = '';
                    this.error = null;

                    // Add user message to chat
                    this.messages.push({
                        role: 'user',
                        content: userMessage
                    });

                    this.scrollToBottom();

                    // Connect WebSocket and send message
                    this.connectWebSocket(userMessage);
                },

                // Connect to WebSocket
                connectWebSocket(userMessage) {
                    this.isTyping = true;
                    this.currentAssistantMessage = '';

                    // Build conversation history (last 10 messages)
                    const history = this.messages
                        .filter(m => m.role === 'user' || m.role === 'assistant')
                        .slice(-10)
                        .slice(0, -1);  // Exclude the message we just added

                    // Connect WebSocket
                    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    this.ws = new WebSocket(`${wsProtocol}//${window.location.host}/ws/chat`);

                    this.ws.onopen = () => {
                        // Send message with configuration
                        const llmUrl = this.llmProvider === 'lmstudio' ? this.lmstudioUrl : this.ollamaUrl;
                        const mcpConfig = this.getCurrentMcpConfig();

                        // For WebSocket we need to pass URL and token (backend looks up by name)
                        let mcpUrl, mcpToken;
                        if (mcpConfig.useConfigName) {
                            // Find the config to get its URL (token stays on server)
                            const config = this.mcpConfigs.find(c => c.name === mcpConfig.name);
                            mcpUrl = config ? config.url : this.mcpServerUrl;
                            mcpToken = '';  // Token is looked up server-side by config name
                        } else {
                            mcpUrl = mcpConfig.url;
                            mcpToken = mcpConfig.token;
                        }

                        this.ws.send(JSON.stringify({
                            model: this.selectedModel,
                            message: userMessage,
                            history: history,
                            temperature: this.temperature,
                            llm_provider: this.llmProvider,
                            llm_url: llmUrl,
                            mcp_url: mcpUrl,
                            mcp_token: mcpToken,
                            mcp_config_name: mcpConfig.useConfigName ? mcpConfig.name : null,
                            system_prompt: this.systemPrompt,
                            force_tools_lmstudio: this.forceToolsLMStudio
                        }));
                    };

                    this.ws.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        this.handleWebSocketMessage(data);
                    };

                    this.ws.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        this.error = 'Verbindingsfout';
                        this.isTyping = false;
                    };

                    this.ws.onclose = () => {
                        this.isTyping = false;
                    };
                },

                // Handle WebSocket message
                handleWebSocketMessage(data) {
                    switch (data.type) {
                        case 'token':
                            // Stream token
                            this.currentAssistantMessage += data.content;

                            // Update or add assistant message
                            const lastMsg = this.messages[this.messages.length - 1];
                            if (lastMsg && lastMsg.role === 'assistant') {
                                lastMsg.content = this.currentAssistantMessage;
                            } else {
                                this.messages.push({
                                    role: 'assistant',
                                    content: this.currentAssistantMessage
                                });
                            }

                            this.scrollToBottom();
                            break;

                        case 'tool_call':
                            // Tool is being called
                            this.messages.push({
                                role: 'tool_call',
                                tool: data.tool,
                                args: data.args
                            });
                            this.scrollToBottom();
                            break;

                        case 'tool_result':
                            // Tool result received
                            this.messages.push({
                                role: 'tool_result',
                                tool: data.tool,
                                result: data.result
                            });
                            this.scrollToBottom();
                            break;

                        case 'done':
                            // Response complete
                            this.isTyping = false;
                            if (this.ws) {
                                this.ws.close();
                            }
                            break;

                        case 'error':
                            // Error occurred
                            this.error = data.content;
                            this.isTyping = false;
                            if (this.ws) {
                                this.ws.close();
                            }
                            break;
                    }
                },

                // Scroll to bottom of messages
                scrollToBottom() {
                    this.$nextTick(() => {
                        const container = this.$refs.messagesContainer;
                        if (container) {
                            container.scrollTop = container.scrollHeight;
                        }
                    });
                },

                // Clear chat
                clearChat() {
                    if (confirm('Weet je zeker dat je de chat wilt wissen?')) {
                        this.messages = [];
                        this.error = null;
                        this.currentAssistantMessage = '';
                    }
                }
            };
        }
    </script>
</body>
</html>
