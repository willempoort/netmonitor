<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=5.0">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Network Monitor - Security Dashboard</title>

    <!-- Bootstrap CSS (CDN) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons (CDN) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
    <!-- Bootstrap Icons Fallback (Unicode symbols) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap-icons-fallback.css') }}">
    <!-- Custom Dashboard CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}?v=4">

    <style>
        /* Loading overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.3s ease-out;
        }
        #loading-overlay.hide {
            opacity: 0;
            pointer-events: none;
            display: none;
        }
        .loading-spinner {
            text-align: center;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
            border-width: 0.3rem;
        }

        /* Fix dropdown positioning when Popper.js is not available */
        .dropdown-menu.show {
            display: block !important;
            position: absolute !important;
            inset: auto !important;
            margin: 0.125rem 0 0 !important;
            transform: none !important;
            top: 100% !important;
            left: 0 !important;
            min-width: 10rem !important;
        }
        .dropdown-menu-end.show {
            left: auto !important;
            right: 0 !important;
        }

        /* Ensure dropdown is above other content */
        .dropdown-menu {
            z-index: 1000 !important;
        }
    </style>
</head>
<body class="bg-dark text-light">

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="loading-spinner">
            <div class="spinner-border text-success" role="status"></div>
            <div class="text-light mt-3" id="loading-message">Loading Security Dashboard...</div>
            <div class="text-muted mt-2" style="font-size: 0.85rem;" id="loading-hint">
                Initializing components...
            </div>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-dark bg-black border-bottom border-secondary">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1 d-flex align-items-center">
                <img src="{{ url_for('static', filename='logo.png') }}" alt="NetMonitor" height="32" class="me-2">
                NetMonitor SOC
            </span>
            <div class="d-flex align-items-center">
                <span class="badge bg-success me-3" id="connection-status">
                    <i class="bi bi-wifi"></i> Connected
                </span>
                <span class="text-muted me-3" id="current-time"></span>

                <!-- User Menu Button -->
                <button class="btn btn-outline-light btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#userMenuModal">
                    <i class="bi bi-person-circle"></i>
                    <span id="user-display-name">{{ user.username if user else 'User' }}</span>
                    <span class="badge bg-primary ms-1" id="user-role-badge">{{ user.role if user else 'operator' }}</span>
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-3">

        <!-- System Stats Row -->
        <div class="row mb-4">
            <!-- Packets/sec Gauge -->
            <div class="col-md-3">
                <div class="card bg-secondary text-white h-100">
                    <div class="card-body text-center">
                        <h6 class="card-title"><i class="bi bi-activity"></i> Packets/sec</h6>
                        <canvas id="packetsGauge" height="150"></canvas>
                        <h3 class="mt-2" id="packets-value">0</h3>
                    </div>
                </div>
            </div>

            <!-- Alerts/min Gauge -->
            <div class="col-md-3">
                <div class="card bg-secondary text-white h-100">
                    <div class="card-body text-center">
                        <h6 class="card-title"><i class="bi bi-exclamation-triangle"></i> Alerts/min</h6>
                        <canvas id="alertsGauge" height="150"></canvas>
                        <h3 class="mt-2" id="alerts-value">0</h3>
                    </div>
                </div>
            </div>

            <!-- CPU Usage -->
            <div class="col-md-3">
                <div class="card bg-secondary text-white h-100">
                    <div class="card-body text-center">
                        <h6 class="card-title"><i class="bi bi-cpu"></i> CPU Usage</h6>
                        <canvas id="cpuGauge" height="150"></canvas>
                        <h3 class="mt-2" id="cpu-value">0%</h3>
                    </div>
                </div>
            </div>

            <!-- Memory Usage -->
            <div class="col-md-3">
                <div class="card bg-secondary text-white h-100">
                    <div class="card-body text-center">
                        <h6 class="card-title"><i class="bi bi-memory"></i> Memory Usage</h6>
                        <canvas id="memoryGauge" height="150"></canvas>
                        <h3 class="mt-2" id="memory-value">0%</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Remote Sensors Row -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card bg-secondary">
                    <div class="card-header d-flex justify-content-between align-items-center" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#sensorsCollapse">
                        <h5 class="mb-0">
                            <i class="bi bi-broadcast"></i> Remote Sensors
                            <span class="badge bg-info ms-2" id="sensors-count">0</span>
                            <span class="badge bg-success ms-1" id="sensors-online">0</span>
                        </h5>
                        <i class="bi bi-chevron-down"></i>
                    </div>
                    <div class="collapse show" id="sensorsCollapse">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-dark table-sm table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <th>Status</th>
                                            <th>Sensor</th>
                                            <th>Location</th>
                                            <th>CPU</th>
                                            <th>RAM</th>
                                            <th>Bandwidth</th>
                                            <th>Packets</th>
                                            <th>Alerts (24h)</th>
                                            <th>Last Seen</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="sensors-table">
                                        <tr>
                                            <td colspan="10" class="text-center text-muted">Loading sensors...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Integrations Status Row (only shown if integrations enabled) -->
        <div class="row mb-3" id="integrations-row" style="display: none;">
            <div class="col-12">
                <div class="card bg-secondary">
                    <div class="card-header d-flex justify-content-between align-items-center" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#integrationsCollapse">
                        <h5 class="mb-0">
                            <i class="bi bi-plug"></i> Integrations
                            <span class="badge bg-info ms-2" id="integrations-count">0</span>
                        </h5>
                        <i class="bi bi-chevron-down"></i>
                    </div>
                    <div class="collapse" id="integrationsCollapse">
                        <div class="card-body">
                            <div class="row">
                                <!-- SIEM Integrations -->
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-2"><i class="bi bi-shield-check"></i> SIEM</h6>
                                    <div id="siem-integrations">
                                        <span class="text-muted">No SIEM integrations enabled</span>
                                    </div>
                                </div>
                                <!-- Threat Intel Integrations -->
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-2"><i class="bi bi-database-check"></i> Threat Intelligence</h6>
                                    <div id="threat-intel-integrations">
                                        <span class="text-muted">No threat intel integrations enabled</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sensor Command Center Row -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card bg-secondary">
                    <div class="card-header d-flex justify-content-between align-items-center" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#commandsCollapse">
                        <h5 class="mb-0">
                            <i class="bi bi-terminal"></i> Sensor Command Center
                        </h5>
                        <i class="bi bi-chevron-down"></i>
                    </div>
                    <div class="collapse" id="commandsCollapse">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label for="command-sensor-select" class="form-label">Select Sensor</label>
                                    <select class="form-select bg-dark text-light border-secondary" id="command-sensor-select">
                                        <option value="">-- Select Sensor --</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="command-type-select" class="form-label">Command</label>
                                    <select class="form-select bg-dark text-light border-secondary" id="command-type-select">
                                        <option value="">-- Select Command --</option>
                                        <option value="get_status">Get Status</option>
                                        <option value="flush_buffer">Flush Alert Buffer</option>
                                        <option value="change_interval">Change Batch Interval</option>
                                        <option value="restart">Restart Sensor</option>
                                    </select>
                                </div>
                                <div class="col-md-4" id="command-params-container" style="display: none;">
                                    <label for="command-params" class="form-label">Parameters (JSON)</label>
                                    <input type="text" class="form-control bg-dark text-light border-secondary" id="command-params" placeholder='{"interval": 60}'>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <button class="btn btn-primary" id="send-command-btn">
                                        <i class="bi bi-send"></i> Send Command
                                    </button>
                                    <button class="btn btn-secondary ms-2" id="command-history-btn">
                                        <i class="bi bi-clock-history"></i> View History
                                    </button>
                                </div>
                            </div>
                            <div id="command-result" class="mt-3" style="display: none;">
                                <div class="alert" role="alert"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- IP Whitelist Management Row -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card bg-secondary">
                    <div class="card-header d-flex justify-content-between align-items-center" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#whitelistCollapse">
                        <h5 class="mb-0">
                            <i class="bi bi-shield-check"></i> IP Whitelist Management
                            <span class="badge bg-info ms-2" id="whitelist-count">0</span>
                        </h5>
                        <i class="bi bi-chevron-down"></i>
                    </div>
                    <div class="collapse" id="whitelistCollapse">
                        <div class="card-body">
                            <!-- Add Whitelist Form -->
                            <div class="row g-3 mb-3">
                                <div class="col-md-2">
                                    <label for="whitelist-ip" class="form-label">IP / CIDR</label>
                                    <input type="text" class="form-control bg-dark text-light border-secondary" id="whitelist-ip" placeholder="192.168.1.0/24">
                                </div>
                                <div class="col-md-2">
                                    <label for="whitelist-description" class="form-label">Description</label>
                                    <input type="text" class="form-control bg-dark text-light border-secondary" id="whitelist-description" placeholder="Internal network">
                                </div>
                                <div class="col-md-2">
                                    <label for="whitelist-direction" class="form-label">Direction</label>
                                    <select class="form-select bg-dark text-light border-secondary" id="whitelist-direction">
                                        <option value="both">Both</option>
                                        <option value="source">Source (FROM this IP)</option>
                                        <option value="destination">Destination (TO this IP)</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="whitelist-scope" class="form-label">Scope</label>
                                    <select class="form-select bg-dark text-light border-secondary" id="whitelist-scope">
                                        <option value="global">Global</option>
                                        <option value="sensor">Sensor-Specific</option>
                                    </select>
                                </div>
                                <div class="col-md-2" id="whitelist-sensor-container" style="display: none;">
                                    <label for="whitelist-sensor-select" class="form-label">Sensor</label>
                                    <select class="form-select bg-dark text-light border-secondary" id="whitelist-sensor-select">
                                        <option value="">-- Select Sensor --</option>
                                    </select>
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button class="btn btn-success w-100" id="add-whitelist-btn">
                                        <i class="bi bi-plus-circle"></i> Add
                                    </button>
                                </div>
                            </div>
                            <!-- Whitelist Table -->
                            <div class="table-responsive">
                                <table class="table table-dark table-sm table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <th>IP / CIDR</th>
                                            <th>Description</th>
                                            <th>Direction</th>
                                            <th>Scope</th>
                                            <th>Sensor</th>
                                            <th>Created</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="whitelist-table">
                                        <tr>
                                            <td colspan="7" class="text-center text-muted">Loading whitelist...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Configuration Management Row -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card bg-secondary">
                    <div class="card-header d-flex justify-content-between align-items-center" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#configCollapse">
                        <h5 class="mb-0">
                            <i class="bi bi-sliders"></i> Configuration Management
                            <span class="badge bg-info ms-2" id="config-params-count">0</span>
                        </h5>
                        <div class="d-flex align-items-center">
                            <button class="btn btn-sm btn-outline-warning me-2" id="reset-config-btn" title="Reset to best practice defaults">
                                <i class="bi bi-arrow-counterclockwise"></i> Reset to Defaults
                            </button>
                            <i class="bi bi-chevron-down"></i>
                        </div>
                    </div>
                    <div class="collapse" id="configCollapse">
                        <div class="card-body">
                            <!-- Sensor Scope Selector -->
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="config-scope-select" class="form-label">
                                        <i class="bi bi-funnel"></i> Configuration Scope
                                    </label>
                                    <select class="form-select bg-dark text-light border-secondary" id="config-scope-select">
                                        <option value="global">Global (All Sensors)</option>
                                        <option value="sensor">Sensor-Specific</option>
                                    </select>
                                </div>
                                <div class="col-md-4" id="config-sensor-container" style="display: none;">
                                    <label for="config-sensor-select" class="form-label">Select Sensor</label>
                                    <select class="form-select bg-dark text-light border-secondary" id="config-sensor-select">
                                        <option value="">-- Select Sensor --</option>
                                    </select>
                                </div>
                                <div class="col-md-4 d-flex align-items-end">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="config-show-defaults" checked>
                                        <label class="form-check-label" for="config-show-defaults">
                                            Show example values
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Category Tabs -->
                            <ul class="nav nav-tabs mb-3" id="configTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="detection-rules-tab" data-bs-toggle="tab" data-bs-target="#detection-rules-pane" type="button" role="tab">
                                        <i class="bi bi-shield-check"></i> Detection Rules
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="ad-security-tab" data-bs-toggle="tab" data-bs-target="#ad-security-pane" type="button" role="tab">
                                        <i class="bi bi-building"></i> Active Directory
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="attack-chain-tab" data-bs-toggle="tab" data-bs-target="#attack-chain-pane" type="button" role="tab">
                                        <i class="bi bi-diagram-3"></i> Attack Chains
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="encrypted-traffic-tab" data-bs-toggle="tab" data-bs-target="#encrypted-traffic-pane" type="button" role="tab">
                                        <i class="bi bi-lock"></i> Encrypted Traffic
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="forensics-tab" data-bs-toggle="tab" data-bs-target="#forensics-pane" type="button" role="tab">
                                        <i class="bi bi-file-earmark-binary"></i> Forensics
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="soar-tab" data-bs-toggle="tab" data-bs-target="#soar-pane" type="button" role="tab">
                                        <i class="bi bi-robot"></i> SOAR
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="thresholds-tab" data-bs-toggle="tab" data-bs-target="#thresholds-pane" type="button" role="tab">
                                        <i class="bi bi-speedometer"></i> Thresholds
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="alerts-config-tab" data-bs-toggle="tab" data-bs-target="#alerts-config-pane" type="button" role="tab">
                                        <i class="bi bi-bell"></i> Alerts
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="performance-tab" data-bs-toggle="tab" data-bs-target="#performance-pane" type="button" role="tab">
                                        <i class="bi bi-lightning"></i> Performance
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="all-params-tab" data-bs-toggle="tab" data-bs-target="#all-params-pane" type="button" role="tab">
                                        <i class="bi bi-list-ul"></i> All
                                    </button>
                                </li>
                            </ul>

                            <!-- Tab Content -->
                            <div class="tab-content" id="configTabContent">
                                <!-- Detection Rules Tab -->
                                <div class="tab-pane fade show active" id="detection-rules-pane" role="tabpanel">
                                    <div id="detection-rules-content" class="config-category-content">
                                        <div class="text-center text-muted p-4">
                                            <div class="spinner-border spinner-border-sm" role="status"></div>
                                            <p class="mt-2">Loading detection rules...</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Active Directory Security Tab -->
                                <div class="tab-pane fade" id="ad-security-pane" role="tabpanel">
                                    <div id="ad-security-content" class="config-category-content">
                                        <div class="text-center text-muted p-4">Loading AD security settings...</div>
                                    </div>
                                </div>

                                <!-- Attack Chain Correlation Tab -->
                                <div class="tab-pane fade" id="attack-chain-pane" role="tabpanel">
                                    <div id="attack-chain-content" class="config-category-content">
                                        <div class="text-center text-muted p-4">Loading attack chain settings...</div>
                                    </div>
                                </div>

                                <!-- Advanced Encrypted Traffic Tab -->
                                <div class="tab-pane fade" id="encrypted-traffic-pane" role="tabpanel">
                                    <div id="encrypted-traffic-content" class="config-category-content">
                                        <div class="text-center text-muted p-4">Loading encrypted traffic settings...</div>
                                    </div>
                                </div>

                                <!-- Forensics (NIS2) Tab -->
                                <div class="tab-pane fade" id="forensics-pane" role="tabpanel">
                                    <div id="forensics-content" class="config-category-content">
                                        <div class="text-center text-muted p-4">Loading forensics settings...</div>
                                    </div>
                                </div>

                                <!-- SOAR Tab -->
                                <div class="tab-pane fade" id="soar-pane" role="tabpanel">
                                    <div id="soar-content" class="config-category-content">
                                        <div class="text-center text-muted p-4">Loading SOAR settings...</div>
                                    </div>
                                </div>

                                <!-- Thresholds Tab -->
                                <div class="tab-pane fade" id="thresholds-pane" role="tabpanel">
                                    <div id="thresholds-content" class="config-category-content">
                                        <div class="text-center text-muted p-4">Loading thresholds...</div>
                                    </div>
                                </div>

                                <!-- Alert Management Tab -->
                                <div class="tab-pane fade" id="alerts-config-pane" role="tabpanel">
                                    <div id="alerts-config-content" class="config-category-content">
                                        <div class="text-center text-muted p-4">Loading alert settings...</div>
                                    </div>
                                </div>

                                <!-- Performance Tab -->
                                <div class="tab-pane fade" id="performance-pane" role="tabpanel">
                                    <div id="performance-content" class="config-category-content">
                                        <div class="text-center text-muted p-4">Loading performance settings...</div>
                                    </div>
                                </div>

                                <!-- All Parameters Tab -->
                                <div class="tab-pane fade" id="all-params-pane" role="tabpanel">
                                    <div id="all-params-content" class="config-category-content">
                                        <div class="text-center text-muted p-4">Loading all parameters...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Device Classification Management Row -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card bg-secondary">
                    <div class="card-header d-flex justify-content-between align-items-center" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#deviceClassificationCollapse">
                        <h5 class="mb-0">
                            <i class="bi bi-diagram-3"></i> Device Classification
                            <span class="badge bg-info ms-2" id="devices-count">0</span>
                            <span class="badge bg-success ms-1" id="devices-classified">0</span>
                        </h5>
                        <i class="bi bi-chevron-down"></i>
                    </div>
                    <div class="collapse" id="deviceClassificationCollapse">
                        <div class="card-body">
                            <!-- Device Classification Tabs -->
                            <ul class="nav nav-tabs nav-fill mb-3" role="tablist">
                                <li class="nav-item">
                                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#devices-tab" type="button">
                                        <i class="bi bi-hdd-network"></i> Devices
                                    </button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#templates-tab" type="button">
                                        <i class="bi bi-file-earmark-code"></i> Templates
                                    </button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#providers-tab" type="button">
                                        <i class="bi bi-cloud"></i> Service Providers
                                    </button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#classification-stats-tab" type="button">
                                        <i class="bi bi-bar-chart"></i> Statistics
                                    </button>
                                </li>
                            </ul>

                            <div class="tab-content">
                                <!-- Devices Tab -->
                                <div class="tab-pane fade show active" id="devices-tab" role="tabpanel">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <div class="input-group" style="max-width: 300px;">
                                            <span class="input-group-text bg-dark border-secondary"><i class="bi bi-search"></i></span>
                                            <input type="text" class="form-control bg-dark text-light border-secondary" id="device-search" placeholder="Search devices...">
                                        </div>
                                        <div>
                                            <select class="form-select form-select-sm bg-dark text-light border-secondary d-inline-block" style="width: auto;" id="device-filter-template">
                                                <option value="">All Templates</option>
                                                <option value="unclassified">Unclassified</option>
                                            </select>
                                            <button class="btn btn-sm btn-outline-success ms-2" onclick="loadDevices()">
                                                <i class="bi bi-arrow-clockwise"></i> Refresh
                                            </button>
                                        </div>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-dark table-sm table-hover mb-0">
                                            <thead>
                                                <tr>
                                                    <th class="device-sort-header" data-sort="ip_address" style="cursor: pointer;" onclick="sortDevices('ip_address')">
                                                        IP Address<span class="sort-indicator"> â–²</span>
                                                    </th>
                                                    <th class="device-sort-header" data-sort="hostname" style="cursor: pointer;" onclick="sortDevices('hostname')">
                                                        Hostname<span class="sort-indicator"></span>
                                                    </th>
                                                    <th class="device-sort-header" data-sort="mac_vendor" style="cursor: pointer;" onclick="sortDevices('mac_vendor')">
                                                        MAC / Vendor<span class="sort-indicator"></span>
                                                    </th>
                                                    <th class="device-sort-header" data-sort="template_name" style="cursor: pointer;" onclick="sortDevices('template_name')">
                                                        Template<span class="sort-indicator"></span>
                                                    </th>
                                                    <th>Learning Status</th>
                                                    <th class="device-sort-header" data-sort="last_seen" style="cursor: pointer;" onclick="sortDevices('last_seen')">
                                                        Last Seen<span class="sort-indicator"></span>
                                                    </th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="devices-table">
                                                <tr>
                                                    <td colspan="7" class="text-center text-muted">Loading devices...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Templates Tab -->
                                <div class="tab-pane fade" id="templates-tab" role="tabpanel">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <div>
                                            <select class="form-select form-select-sm bg-dark text-light border-secondary d-inline-block" style="width: auto;" id="template-filter-category">
                                                <option value="">All Categories</option>
                                                <option value="iot">IoT</option>
                                                <option value="server">Server</option>
                                                <option value="endpoint">Endpoint</option>
                                                <option value="other">Other</option>
                                            </select>
                                        </div>
                                        <button class="btn btn-sm btn-success" onclick="showCreateTemplateModal()">
                                            <i class="bi bi-plus-circle"></i> New Template
                                        </button>
                                    </div>
                                    <div class="row" id="templates-grid">
                                        <div class="col-12 text-center text-muted p-4">Loading templates...</div>
                                    </div>
                                </div>

                                <!-- Service Providers Tab -->
                                <div class="tab-pane fade" id="providers-tab" role="tabpanel">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <div>
                                            <select class="form-select form-select-sm bg-dark text-light border-secondary d-inline-block" style="width: auto;" id="provider-filter-category">
                                                <option value="">All Categories</option>
                                                <option value="streaming">Streaming</option>
                                                <option value="cdn">CDN</option>
                                                <option value="cloud">Cloud</option>
                                                <option value="social">Social</option>
                                                <option value="gaming">Gaming</option>
                                                <option value="other">Other</option>
                                            </select>
                                        </div>
                                        <button class="btn btn-sm btn-success" onclick="showCreateProviderModal()">
                                            <i class="bi bi-plus-circle"></i> New Provider
                                        </button>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-dark table-sm table-hover mb-0">
                                            <thead>
                                                <tr>
                                                    <th>Name</th>
                                                    <th>Category</th>
                                                    <th>IP Ranges</th>
                                                    <th>Domains</th>
                                                    <th>Type</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="providers-table">
                                                <tr>
                                                    <td colspan="6" class="text-center text-muted">Loading providers...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Classification Statistics Tab -->
                                <div class="tab-pane fade" id="classification-stats-tab" role="tabpanel">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="card bg-dark border-secondary">
                                                <div class="card-body text-center">
                                                    <h3 class="text-info" id="stat-total-devices">0</h3>
                                                    <p class="text-muted mb-0">Total Devices</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card bg-dark border-secondary">
                                                <div class="card-body text-center">
                                                    <h3 class="text-success" id="stat-classified">0</h3>
                                                    <p class="text-muted mb-0">Classified</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card bg-dark border-secondary">
                                                <div class="card-body text-center">
                                                    <h3 class="text-warning" id="stat-unclassified">0</h3>
                                                    <p class="text-muted mb-0">Unclassified</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <h6><i class="bi bi-pie-chart"></i> Devices by Template</h6>
                                            <div id="devices-by-template" class="mt-2">
                                                <p class="text-muted">Loading...</p>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <h6><i class="bi bi-building"></i> Devices by Vendor</h6>
                                            <div id="devices-by-vendor" class="mt-2">
                                                <p class="text-muted">Loading...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Traffic Stats Row -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card bg-secondary h-100">
                    <div class="card-header">
                        <h5><i class="bi bi-graph-up"></i> Traffic Volume (24h)</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="trafficChart" height="200"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card bg-secondary h-100">
                    <div class="card-header">
                        <h5><i class="bi bi-pie-chart"></i> Alert Distribution</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="alertPieChart" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Row -->
        <div class="row">
            <!-- Recent Alerts -->
            <div class="col-lg-6 col-md-12 mb-3">
                <div class="card bg-secondary h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="bi bi-bell"></i> Recent Alerts</h5>
                        <span class="badge bg-danger" id="alert-count">0</span>
                    </div>
                    <div class="card-body p-0">
                        <div class="alert-feed" id="alert-feed">
                            <div class="text-center text-muted p-4">
                                Loading alerts...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top Talkers -->
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card bg-secondary h-100">
                    <div class="card-header">
                        <h5><i class="bi bi-people"></i> Top Talkers</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-dark table-sm table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>IP/Hostname</th>
                                        <th>Traffic</th>
                                        <th>Dir</th>
                                    </tr>
                                </thead>
                                <tbody id="top-talkers-table">
                                    <tr>
                                        <td colspan="3" class="text-center text-muted">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Threat Types -->
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card bg-secondary h-100">
                    <div class="card-header">
                        <h5><i class="bi bi-bug"></i> Threat Types</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="list-group list-group-flush" id="threat-types-list">
                            <div class="list-group-item bg-dark text-muted text-center">
                                Loading...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Alert Details Modal -->
    <div class="modal fade" id="alertDetailsModal" tabindex="-1" aria-labelledby="alertDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header">
                    <h5 class="modal-title" id="alertDetailsModalLabel">
                        <i class="bi bi-info-circle"></i> Alert Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="alertDetailsBody">
                    <!-- Alert details will be populated here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Threat Type Details Modal -->
    <div class="modal fade" id="threatDetailsModal" tabindex="-1" aria-labelledby="threatDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header">
                    <h5 class="modal-title" id="threatDetailsModalLabel">
                        <i class="bi bi-bug-fill"></i> Threat Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="threatDetailsBody">
                    <!-- Loading indicator -->
                    <div id="threatDetailsLoading" class="text-center p-4">
                        <div class="spinner-border text-success" role="status"></div>
                        <div class="text-muted mt-2">Loading threat details...</div>
                    </div>
                    <!-- Threat details will be populated here -->
                    <div id="threatDetailsContent" style="display: none;">
                        <!-- Statistics Cards -->
                        <div class="row mb-4" id="threatStatsRow">
                            <!-- Statistics will be populated here -->
                        </div>

                        <!-- Tabs -->
                        <ul class="nav nav-tabs mb-3" id="threatDetailsTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview-pane" type="button" role="tab">
                                    <i class="bi bi-grid"></i> Overview
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="sources-tab" data-bs-toggle="tab" data-bs-target="#sources-pane" type="button" role="tab">
                                    <i class="bi bi-hdd-network"></i> Source IPs
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="targets-tab" data-bs-toggle="tab" data-bs-target="#targets-pane" type="button" role="tab">
                                    <i class="bi bi-hdd-network-fill"></i> Targets
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="alerts-tab" data-bs-toggle="tab" data-bs-target="#alerts-pane" type="button" role="tab">
                                    <i class="bi bi-list-ul"></i> All Alerts
                                </button>
                            </li>
                        </ul>

                        <!-- Tab Content -->
                        <div class="tab-content" id="threatDetailsTabContent">
                            <!-- Overview Tab -->
                            <div class="tab-pane fade show active" id="overview-pane" role="tabpanel">
                                <div id="threatOverviewContent"></div>
                            </div>

                            <!-- Sources Tab -->
                            <div class="tab-pane fade" id="sources-pane" role="tabpanel">
                                <div class="table-responsive">
                                    <table class="table table-dark table-striped">
                                        <thead>
                                            <tr>
                                                <th>Source IP</th>
                                                <th>Hostname</th>
                                                <th>Country</th>
                                                <th>Count</th>
                                            </tr>
                                        </thead>
                                        <tbody id="threatSourcesTable"></tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Targets Tab -->
                            <div class="tab-pane fade" id="targets-pane" role="tabpanel">
                                <div class="table-responsive">
                                    <table class="table table-dark table-striped">
                                        <thead>
                                            <tr>
                                                <th>Target IP</th>
                                                <th>Hostname</th>
                                                <th>Country</th>
                                                <th>Count</th>
                                            </tr>
                                        </thead>
                                        <tbody id="threatTargetsTable"></tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- All Alerts Tab -->
                            <div class="tab-pane fade" id="alerts-pane" role="tabpanel">
                                <div id="threatAlertsContent"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reset Config Confirmation Modal -->
    <div class="modal fade" id="resetConfigModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle text-warning"></i>
                        Reset Configuration to Defaults
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-warning">
                        <i class="bi bi-exclamation-circle"></i>
                        <strong>Warning:</strong> This will reset all configuration parameters to best practice defaults.
                    </p>
                    <p>This action will:</p>
                    <ul>
                        <li>Reset detection rules to recommended settings</li>
                        <li>Update thresholds to best practice values</li>
                        <li>Configure alert management for optimal performance</li>
                        <li>Apply settings to: <strong id="reset-scope-display">Global (All Sensors)</strong></li>
                    </ul>
                    <p class="text-muted">
                        <i class="bi bi-info-circle"></i>
                        Sensors will automatically sync within 5 minutes. No restart required.
                    </p>
                    <div class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" id="reset-confirm-checkbox">
                        <label class="form-check-label" for="reset-confirm-checkbox">
                            I understand that this will overwrite current settings
                        </label>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" id="confirm-reset-btn" disabled>
                        <i class="bi bi-arrow-counterclockwise"></i> Reset to Defaults
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Sensor Settings Modal -->
    <div class="modal fade" id="editSensorModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">
                        <i class="bi bi-sliders"></i>
                        Edit Sensor Settings
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit-sensor-id">
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="bi bi-hdd-network"></i> Sensor Information
                        </label>
                        <div class="alert alert-secondary">
                            <strong id="edit-sensor-name"></strong><br>
                            <small class="text-muted" id="edit-sensor-id-display"></small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="edit-sensor-location" class="form-label">
                            <i class="bi bi-geo-alt"></i> Sensor Location
                        </label>
                        <input type="text" class="form-control bg-secondary text-light border-secondary"
                               id="edit-sensor-location" placeholder="e.g., Building A - VLAN 10">
                        <small class="form-text text-muted">Physical location or network segment description</small>
                    </div>

                    <div class="mb-3">
                        <label for="edit-sensor-interface" class="form-label">
                            <i class="bi bi-ethernet"></i> Network Interface(s)
                        </label>
                        <select class="form-select bg-secondary text-light border-secondary"
                                id="edit-sensor-interface" multiple size="4">
                            <option value="loading" disabled>Loading available interfaces...</option>
                        </select>
                        <small class="form-text text-light opacity-75">
                            Select one or more interfaces to monitor. Hold Ctrl/Cmd to select multiple.
                            <strong class="text-warning">Note:</strong> Sensor restart required after change.
                        </small>
                    </div>

                    <div class="mb-3">
                        <label for="edit-internal-networks" class="form-label">
                            <i class="bi bi-diagram-3"></i> Internal Networks (CIDR)
                        </label>
                        <textarea class="form-control bg-secondary text-light border-secondary"
                                  id="edit-internal-networks" rows="3"
                                  placeholder="10.0.0.0/8&#10;172.16.0.0/12&#10;192.168.0.0/16"></textarea>
                        <small class="form-text text-muted">One network per line (e.g., 192.168.1.0/24)</small>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit-heartbeat-interval" class="form-label">
                                <i class="bi bi-heartbeat"></i> Heartbeat Interval (seconds)
                            </label>
                            <input type="number" class="form-control bg-secondary text-light border-secondary"
                                   id="edit-heartbeat-interval" min="10" max="300" value="30">
                            <small class="form-text text-muted">How often sensor sends heartbeat (default: 30s)</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit-config-sync-interval" class="form-label">
                                <i class="bi bi-arrow-repeat"></i> Config Sync Interval (seconds)
                            </label>
                            <input type="number" class="form-control bg-secondary text-light border-secondary"
                                   id="edit-config-sync-interval" min="60" max="3600" value="300">
                            <small class="form-text text-muted">How often sensor syncs config (default: 300s)</small>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="edit-batch-interval" class="form-label">
                                <i class="bi bi-collection"></i> Alert Batch Interval (seconds)
                            </label>
                            <input type="number" class="form-control bg-secondary text-light border-secondary"
                                   id="edit-batch-interval" min="10" max="300" value="30">
                            <small class="form-text text-muted">How often alerts are uploaded (default: 30s)</small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="edit-metrics-interval" class="form-label">
                                <i class="bi bi-graph-up"></i> Metrics Interval (seconds)
                            </label>
                            <input type="number" class="form-control bg-secondary text-light border-secondary"
                                   id="edit-metrics-interval" min="30" max="600" value="60">
                            <small class="form-text text-muted">How often metrics are sent (default: 60s)</small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="edit-min-severity" class="form-label">
                                <i class="bi bi-funnel"></i> Minimum Alert Severity
                            </label>
                            <select class="form-select bg-secondary text-light border-secondary" id="edit-min-severity">
                                <option value="LOW">LOW (All Alerts)</option>
                                <option value="MEDIUM">MEDIUM (Medium + High + Critical)</option>
                                <option value="HIGH">HIGH (High + Critical)</option>
                                <option value="CRITICAL">CRITICAL (Only Critical)</option>
                            </select>
                            <small class="form-text text-muted">Filter alerts by severity (saves bandwidth)</small>
                        </div>
                    </div>

                    <!-- PCAP Forensics Settings (NIS2 Compliance) -->
                    <div class="mb-3 mt-4">
                        <label class="form-label fw-bold">
                            <i class="bi bi-camera-video"></i> PCAP Forensics (NIS2 Compliance)
                        </label>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit-pcap-enabled" class="form-label">
                                <i class="bi bi-toggle-on"></i> PCAP Capture Enabled
                            </label>
                            <select class="form-select bg-secondary text-light border-secondary" id="edit-pcap-enabled">
                                <option value="true">Enabled (NIS2 Required)</option>
                                <option value="false">Disabled</option>
                            </select>
                            <small class="form-text text-muted">Enable packet capture for forensic analysis</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit-pcap-upload" class="form-label">
                                <i class="bi bi-cloud-upload"></i> Upload to SOC
                            </label>
                            <select class="form-select bg-secondary text-light border-secondary" id="edit-pcap-upload">
                                <option value="true">Enabled (NIS2 Required)</option>
                                <option value="false">Local Only</option>
                            </select>
                            <small class="form-text text-muted">Upload PCAP files to central SOC server</small>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit-pcap-keep-local" class="form-label">
                                <i class="bi bi-hdd"></i> Keep Local Copy
                            </label>
                            <select class="form-select bg-secondary text-light border-secondary" id="edit-pcap-keep-local">
                                <option value="false">Delete After Upload (Recommended)</option>
                                <option value="true">Keep Local Copy</option>
                            </select>
                            <small class="form-text text-muted">Keep PCAP files on sensor after upload (uses disk space)</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit-pcap-ram-threshold" class="form-label">
                                <i class="bi bi-memory"></i> RAM Flush Threshold (%)
                            </label>
                            <input type="number" class="form-control bg-secondary text-light border-secondary"
                                   id="edit-pcap-ram-threshold" min="50" max="95" value="75">
                            <small class="form-text text-muted">Flush PCAP buffer when RAM exceeds this % (default: 75)</small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="edit-pcap-output-dir" class="form-label">
                            <i class="bi bi-folder"></i> PCAP Output Directory
                        </label>
                        <input type="text" class="form-control bg-secondary text-light border-secondary"
                               id="edit-pcap-output-dir" value="/var/log/netmonitor/pcap" placeholder="/var/log/netmonitor/pcap">
                        <small class="form-text text-muted">Local directory for PCAP file storage</small>
                    </div>

                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Note:</strong> Changes will be picked up automatically within the configured sync interval.
                        To apply immediately, restart the sensor.
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="save-sensor-settings-btn" onclick="saveSensorSettings()">
                        <i class="bi bi-save"></i> Save Settings
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Device Details Modal -->
    <div class="modal fade" id="deviceDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">
                        <i class="bi bi-hdd-network"></i> Device Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="device-detail-ip">

                    <!-- Device Info -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label text-muted">IP Address</label>
                            <p class="fw-bold" id="device-detail-ip-display">-</p>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-muted">Hostname</label>
                            <p class="fw-bold" id="device-detail-hostname">-</p>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label text-muted">MAC Address</label>
                            <p class="fw-bold" id="device-detail-mac">-</p>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-muted">Vendor</label>
                            <p class="fw-bold" id="device-detail-vendor">-</p>
                        </div>
                    </div>

                    <!-- Template Assignment -->
                    <hr class="border-secondary">
                    <h6><i class="bi bi-tag"></i> Template Assignment</h6>
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <select class="form-select bg-secondary text-light border-secondary" id="device-template-select">
                                <option value="">No Template (Unclassified)</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-primary w-100" onclick="assignDeviceTemplate()">
                                <i class="bi bi-check"></i> Assign
                            </button>
                        </div>
                    </div>

                    <!-- Learning Status -->
                    <hr class="border-secondary">
                    <h6><i class="bi bi-lightbulb"></i> Behavior Learning</h6>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="card bg-secondary border-0">
                                <div class="card-body text-center py-2">
                                    <small class="text-muted">Packets Analyzed</small>
                                    <h5 class="mb-0" id="device-detail-packets">0</h5>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-secondary border-0">
                                <div class="card-body text-center py-2">
                                    <small class="text-muted">Unique Ports</small>
                                    <h5 class="mb-0" id="device-detail-ports">0</h5>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-secondary border-0">
                                <div class="card-body text-center py-2">
                                    <small class="text-muted">Status</small>
                                    <h5 class="mb-0" id="device-detail-status">-</h5>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Classification Hints -->
                    <div id="device-classification-hints" class="alert alert-info" style="display: none;">
                        <strong><i class="bi bi-lightbulb"></i> Suggested Templates:</strong>
                        <ul class="mb-0 mt-2" id="device-hints-list"></ul>
                    </div>

                    <!-- Create Template from Device -->
                    <div class="card bg-secondary border-0 mt-3" id="create-template-from-device-card" style="display: none;">
                        <div class="card-body">
                            <h6><i class="bi bi-magic"></i> Create Template from Learned Behavior</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <input type="text" class="form-control bg-dark text-light border-secondary"
                                           id="new-template-from-device-name" placeholder="Template name">
                                </div>
                                <div class="col-md-4">
                                    <select class="form-select bg-dark text-light border-secondary" id="new-template-from-device-category">
                                        <option value="iot">IoT</option>
                                        <option value="server">Server</option>
                                        <option value="endpoint">Endpoint</option>
                                        <option value="other" selected>Other</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-success w-100" onclick="createTemplateFromDevice()">
                                        <i class="bi bi-plus"></i> Create
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-danger" onclick="deleteDevice()">
                        <i class="bi bi-trash"></i> Delete Device
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Template Modal -->
    <div class="modal fade" id="createTemplateModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">
                        <i class="bi bi-plus-circle"></i> Create Device Template
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="template-name" class="form-label">Template Name</label>
                        <input type="text" class="form-control bg-secondary text-light border-secondary"
                               id="template-name" placeholder="e.g., IP Camera, Smart TV">
                    </div>
                    <div class="mb-3">
                        <label for="template-category" class="form-label">Category</label>
                        <select class="form-select bg-secondary text-light border-secondary" id="template-category">
                            <option value="iot">IoT</option>
                            <option value="server">Server</option>
                            <option value="endpoint">Endpoint</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="template-description" class="form-label">Description</label>
                        <textarea class="form-control bg-secondary text-light border-secondary"
                                  id="template-description" rows="2" placeholder="Optional description"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="template-icon" class="form-label">Icon</label>
                        <select class="form-select bg-secondary text-light border-secondary" id="template-icon">
                            <option value="device">ðŸ“± Device</option>
                            <option value="camera">ðŸ“· Camera</option>
                            <option value="tv">ðŸ“º TV</option>
                            <option value="speaker">ðŸ”Š Speaker</option>
                            <option value="server">ðŸ–¥ï¸ Server</option>
                            <option value="router">ðŸŒ Router</option>
                            <option value="printer">ðŸ–¨ï¸ Printer</option>
                            <option value="other">âš™ï¸ Other</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="createTemplate()">
                        <i class="bi bi-plus-circle"></i> Create Template
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Template Details Modal -->
    <div class="modal fade" id="templateDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">
                        <i class="bi bi-file-earmark-code"></i> Template Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="template-detail-id">

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label text-muted">Name</label>
                            <p class="fw-bold" id="template-detail-name">-</p>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label text-muted">Category</label>
                            <p class="fw-bold" id="template-detail-category">-</p>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label text-muted">Type</label>
                            <p class="fw-bold" id="template-detail-type">-</p>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-muted">Description</label>
                        <p id="template-detail-description">-</p>
                    </div>

                    <hr class="border-secondary">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0"><i class="bi bi-list-check"></i> Behavior Rules</h6>
                        <button class="btn btn-sm btn-outline-success" onclick="showAddBehaviorForm()">
                            <i class="bi bi-plus"></i> Add Rule
                        </button>
                    </div>

                    <!-- Add Behavior Form (hidden by default) -->
                    <div id="add-behavior-form" class="card bg-secondary mb-3" style="display: none;">
                        <div class="card-body">
                            <div class="row g-2">
                                <div class="col-md-3">
                                    <label class="form-label small">Behavior Type</label>
                                    <select class="form-select form-select-sm bg-dark text-light border-secondary" id="new-behavior-type" onchange="updateBehaviorPlaceholder()">
                                        <option value="allowed_ports">Allowed Port(s)</option>
                                        <option value="allowed_protocols">Allowed Protocol</option>
                                        <option value="allowed_sources">Allowed Sources</option>
                                        <option value="bandwidth_limit">Bandwidth Limit (MB/h)</option>
                                        <option value="connection_behavior">Connection Behavior</option>
                                        <option value="expected_destinations">Expected Destination</option>
                                        <option value="time_restrictions">Time Restriction</option>
                                        <option value="dns_behavior">DNS Behavior</option>
                                        <option value="traffic_pattern">Traffic Pattern</option>
                                        <option value="suppress_alert_types">Suppress Alert Types</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small">Value</label>
                                    <input type="text" class="form-control form-control-sm bg-dark text-light border-secondary"
                                           id="new-behavior-value" placeholder="e.g., 443 or 5060-5090">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small">Direction</label>
                                    <select class="form-select form-select-sm bg-dark text-light border-secondary" id="new-behavior-direction">
                                        <option value="">Both (default)</option>
                                        <option value="inbound">Inbound (traffic TO device)</option>
                                        <option value="outbound">Outbound (traffic FROM device)</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small">Action</label>
                                    <select class="form-select form-select-sm bg-dark text-light border-secondary" id="new-behavior-action">
                                        <option value="allow">Allow (suppress alerts)</option>
                                        <option value="suppress">Suppress (hide alerts)</option>
                                        <option value="alert">Alert (always notify)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row g-2 mt-2">
                                <div class="col-md-8">
                                    <label class="form-label small">Description (optional)</label>
                                    <input type="text" class="form-control form-control-sm bg-dark text-light border-secondary"
                                           id="new-behavior-description" placeholder="e.g., SIP signaling ports">
                                </div>
                                <div class="col-md-4 d-flex align-items-end">
                                    <button class="btn btn-sm btn-success me-2" onclick="addBehaviorRule()">
                                        <i class="bi bi-check"></i> Add
                                    </button>
                                    <button class="btn btn-sm btn-secondary" onclick="hideAddBehaviorForm()">
                                        <i class="bi bi-x"></i> Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-dark table-sm">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Value</th>
                                    <th>Direction</th>
                                    <th>Action</th>
                                    <th>Description</th>
                                    <th style="width: 50px;"></th>
                                </tr>
                            </thead>
                            <tbody id="template-behaviors-table">
                                <tr>
                                    <td colspan="6" class="text-center text-muted">No behaviors defined</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Devices using this template -->
                    <hr class="border-secondary">
                    <h6><i class="bi bi-hdd-network"></i> Devices Using This Template</h6>
                    <div id="template-devices-list" class="text-muted">
                        No devices assigned to this template.
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-info" onclick="cloneTemplate()" title="Create an editable copy of this template">
                        <i class="bi bi-copy"></i> Clone
                    </button>
                    <button type="button" class="btn btn-danger" id="delete-template-btn" onclick="deleteTemplate()" style="display: none;">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Service Provider Modal -->
    <div class="modal fade" id="createProviderModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">
                        <i class="bi bi-plus-circle"></i> Add Service Provider
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="provider-name" class="form-label">Provider Name</label>
                        <input type="text" class="form-control bg-secondary text-light border-secondary"
                               id="provider-name" placeholder="e.g., Netflix, Cloudflare">
                    </div>
                    <div class="mb-3">
                        <label for="provider-category" class="form-label">Category</label>
                        <select class="form-select bg-secondary text-light border-secondary" id="provider-category">
                            <option value="streaming">Streaming</option>
                            <option value="cdn">CDN</option>
                            <option value="cloud">Cloud</option>
                            <option value="social">Social</option>
                            <option value="gaming">Gaming</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="provider-ip-ranges" class="form-label">IP Ranges (CIDR, one per line)</label>
                        <textarea class="form-control bg-secondary text-light border-secondary"
                                  id="provider-ip-ranges" rows="3" placeholder="e.g., 185.2.220.0/24"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="provider-domains" class="form-label">Domains (one per line)</label>
                        <textarea class="form-control bg-secondary text-light border-secondary"
                                  id="provider-domains" rows="2" placeholder="e.g., netflix.com"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="provider-description" class="form-label">Description</label>
                        <input type="text" class="form-control bg-secondary text-light border-secondary"
                               id="provider-description" placeholder="Optional description">
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="createProvider()">
                        <i class="bi bi-plus-circle"></i> Add Provider
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- User Profile Modal -->
    <div class="modal fade" id="userProfileModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">
                        <i class="bi bi-person-gear"></i> Profile Settings
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="profile-username" class="form-label"><i class="bi bi-person"></i> Username</label>
                        <input type="text" class="form-control bg-secondary text-light" id="profile-username" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="profile-email" class="form-label"><i class="bi bi-envelope"></i> Email</label>
                        <input type="email" class="form-control bg-secondary text-light" id="profile-email" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="profile-role" class="form-label"><i class="bi bi-shield-check"></i> Role</label>
                        <input type="text" class="form-control bg-secondary text-light" id="profile-role" readonly>
                    </div>
                    <hr class="border-secondary">
                    <h6><i class="bi bi-key"></i> Change Password</h6>
                    <div class="mb-3">
                        <label for="current-password" class="form-label">Current Password</label>
                        <input type="password" class="form-control bg-secondary text-light border-secondary" id="current-password">
                    </div>
                    <div class="mb-3">
                        <label for="new-password" class="form-label">New Password</label>
                        <input type="password" class="form-control bg-secondary text-light border-secondary" id="new-password">
                        <small class="text-muted">Minimum 12 characters</small>
                    </div>
                    <button class="btn btn-primary" onclick="changePassword()">
                        <i class="bi bi-key"></i> Change Password
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 2FA Setup Modal -->
    <div class="modal fade" id="twoFactorModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">
                        <i class="bi bi-shield-lock"></i> Two-Factor Authentication
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="twoFactorContent">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2">Loading...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Management Modal (Admin Only) -->
    <div class="modal fade" id="userManagementModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">
                        <i class="bi bi-people"></i> User Management
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <button class="btn btn-success" onclick="showCreateUserForm()">
                            <i class="bi bi-plus-circle"></i> Create New User
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-dark table-striped">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>2FA</th>
                                    <th>Last Login</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body">
                                <tr>
                                    <td colspan="6" class="text-center">Loading users...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create User Modal -->
    <div class="modal fade" id="createUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">
                        <i class="bi bi-person-plus"></i> Create New User
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Username *</label>
                        <input type="text" class="form-control bg-secondary text-light border-secondary" id="create-username" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control bg-secondary text-light border-secondary" id="create-email">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Password *</label>
                        <input type="password" class="form-control bg-secondary text-light border-secondary" id="create-password" required>
                        <small class="text-muted">Minimum 12 characters</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Role *</label>
                        <select class="form-select bg-secondary text-light border-secondary" id="create-role">
                            <option value="viewer">Viewer (Read-only)</option>
                            <option value="operator" selected>Operator (Manage sensors & alerts)</option>
                            <option value="admin">Admin (Full access)</option>
                        </select>
                    </div>
                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" id="create-enable-2fa">
                        <label class="form-check-label" for="create-enable-2fa">
                            Enable 2FA (recommended)
                        </label>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createUser()">
                        <i class="bi bi-save"></i> Create User
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- User Menu Modal -->
    <div class="modal fade" id="userMenuModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">
                        <i class="bi bi-person-circle"></i> {{ user.username if user else 'User' }}
                        <span class="badge bg-primary ms-2">{{ user.role if user else 'operator' }}</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-light text-start" onclick="showUserProfile(); bootstrap.Modal.getInstance(document.getElementById('userMenuModal')).hide();">
                            <i class="bi bi-person-gear"></i> Profile Settings
                        </button>

                        <button class="btn btn-outline-light text-start" onclick="show2FASetup(); bootstrap.Modal.getInstance(document.getElementById('userMenuModal')).hide();">
                            <i class="bi bi-shield-lock"></i> Two-Factor Authentication
                        </button>

                        {% if user and user.role == 'admin' %}
                        <hr class="border-secondary my-2">
                        <button class="btn btn-outline-light text-start" onclick="showUserManagement(); bootstrap.Modal.getInstance(document.getElementById('userMenuModal')).hide();">
                            <i class="bi bi-people"></i> User Management
                        </button>
                        {% endif %}

                        <hr class="border-secondary my-2">
                        <button class="btn btn-outline-danger text-start" onclick="logout(); bootstrap.Modal.getInstance(document.getElementById('userMenuModal')).hide();">
                            <i class="bi bi-box-arrow-right"></i> Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- External Libraries -->
    <!-- Bootstrap JS must load first (no defer) for dropdown and modal functionality -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Initialize Bootstrap dropdowns after everything is loaded -->
    <script>
        // Wait for both DOM and window load
        function initializeDropdowns() {
            console.log('[DROPDOWN] Initializing Bootstrap dropdowns...');

            // Find all dropdown toggles
            var dropdownElements = document.querySelectorAll('[data-bs-toggle="dropdown"]');
            console.log('[DROPDOWN] Found dropdown elements:', dropdownElements.length);

            if (dropdownElements.length === 0) {
                console.warn('[DROPDOWN] No dropdown elements found!');
                return;
            }

            // Initialize each dropdown
            dropdownElements.forEach(function(element) {
                try {
                    // Check if already initialized
                    var dropdown = bootstrap.Dropdown.getInstance(element);
                    if (!dropdown) {
                        dropdown = new bootstrap.Dropdown(element);
                        console.log('[DROPDOWN] Initialized:', element.id || element.className);
                    } else {
                        console.log('[DROPDOWN] Already initialized:', element.id || element.className);
                    }
                } catch (e) {
                    console.error('[DROPDOWN] Error initializing dropdown:', e);
                }
            });

            console.log('[DROPDOWN] Initialization complete');
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeDropdowns);
        } else {
            // DOM already loaded
            initializeDropdowns();
        }

        // Re-initialize after loading overlay is hidden (to ensure it's clickable)
        window.addEventListener('load', function() {
            setTimeout(initializeDropdowns, 500);
        });
    </script>

    <!-- Other libraries can load asynchronously (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" defer></script>
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js" defer></script>

    <!-- Authentication & User Management Script -->
    <script>
        // Logout function
        async function logout() {
            if (!confirm('Are you sure you want to logout?')) return;

            try {
                const response = await fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    window.location.href = '/login';
                } else {
                    alert('Logout failed. Please try again.');
                }
            } catch (error) {
                console.error('Logout error:', error);
                alert('Network error during logout.');
            }
        }

        // Show user profile modal
        async function showUserProfile() {
            try {
                const response = await fetch('/api/auth/current-user');
                const result = await response.json();

                if (result.success) {
                    const user = result.user;
                    document.getElementById('profile-username').value = user.username || '';
                    document.getElementById('profile-email').value = user.email || '';
                    document.getElementById('profile-role').value = user.role || '';

                    const modal = new bootstrap.Modal(document.getElementById('userProfileModal'));
                    modal.show();
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
                alert('Failed to load user profile.');
            }
        }

        // Change password
        async function changePassword() {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;

            if (!currentPassword || !newPassword) {
                alert('Please enter both current and new password.');
                return;
            }

            if (newPassword.length < 12) {
                alert('New password must be at least 12 characters.');
                return;
            }

            try {
                const response = await fetch('/api/auth/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        old_password: currentPassword,
                        new_password: newPassword
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert('Password changed successfully!');
                    document.getElementById('current-password').value = '';
                    document.getElementById('new-password').value = '';
                    bootstrap.Modal.getInstance(document.getElementById('userProfileModal')).hide();
                } else {
                    alert(result.error || 'Failed to change password.');
                }
            } catch (error) {
                console.error('Error changing password:', error);
                alert('Network error while changing password.');
            }
        }

        // Show 2FA setup modal
        async function show2FASetup() {
            const modal = new bootstrap.Modal(document.getElementById('twoFactorModal'));
            modal.show();

            // Load current 2FA status
            try {
                const response = await fetch('/api/auth/current-user');
                const result = await response.json();

                if (result.success) {
                    const user = result.user;
                    const content = document.getElementById('twoFactorContent');

                    if (user.totp_enabled) {
                        // 2FA is enabled
                        content.innerHTML = `
                            <div class="alert alert-success">
                                <i class="bi bi-shield-check"></i>
                                <strong>Two-Factor Authentication is ENABLED</strong>
                                <p class="mb-0 mt-2">Your account is protected with 2FA.</p>
                            </div>
                            <button class="btn btn-danger" onclick="disable2FA()">
                                <i class="bi bi-x-circle"></i> Disable 2FA
                            </button>
                        `;
                    } else {
                        // 2FA is not enabled - show setup
                        content.innerHTML = `
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i>
                                <strong>Two-Factor Authentication is DISABLED</strong>
                                <p class="mb-0 mt-2">Enable 2FA to add an extra layer of security to your account.</p>
                            </div>
                            <button class="btn btn-success" onclick="enable2FA()">
                                <i class="bi bi-shield-plus"></i> Enable 2FA
                            </button>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error loading 2FA status:', error);
                document.getElementById('twoFactorContent').innerHTML = `
                    <div class="alert alert-danger">Error loading 2FA status.</div>
                `;
            }
        }

        // Enable 2FA
        async function enable2FA() {
            try {
                const response = await fetch('/api/auth/setup-2fa', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (result.success) {
                    // Show QR code and backup codes
                    const content = document.getElementById('twoFactorContent');
                    content.innerHTML = `
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle"></i>
                            <strong>2FA Enabled Successfully!</strong>
                        </div>
                        <div class="text-center mb-4">
                            <p>Scan this QR code with your authenticator app:</p>
                            <img src="data:image/png;base64,${result.qr_code}" alt="QR Code" class="img-fluid" style="max-width: 300px;">
                            <p class="mt-2 text-muted">Secret: <code>${result.secret}</code></p>
                        </div>
                        <div class="alert alert-warning">
                            <strong><i class="bi bi-key"></i> Backup Codes (Save these!)</strong>
                            <p class="mb-2">Use these codes if you lose access to your authenticator:</p>
                            <div class="row">
                                ${result.backup_codes.map((code, i) => `
                                    <div class="col-6 mb-1"><code>${code}</code></div>
                                `).join('')}
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="show2FASetup()">
                            <i class="bi bi-check"></i> Done
                        </button>
                    `;
                } else {
                    alert('Failed to enable 2FA: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error enabling 2FA:', error);
                alert('Network error while enabling 2FA.');
            }
        }

        // Disable 2FA
        async function disable2FA() {
            if (!confirm('Are you sure you want to disable Two-Factor Authentication?')) return;

            try {
                const response = await fetch('/api/auth/disable-2fa', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (result.success) {
                    alert('2FA disabled successfully.');
                    show2FASetup(); // Refresh modal
                } else {
                    alert('Failed to disable 2FA: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error disabling 2FA:', error);
                alert('Network error while disabling 2FA.');
            }
        }

        // Show user management modal (admin only)
        async function showUserManagement() {
            const modal = new bootstrap.Modal(document.getElementById('userManagementModal'));
            modal.show();

            // Load users
            try {
                const response = await fetch('/api/users');
                const result = await response.json();

                if (result.success) {
                    const tbody = document.getElementById('users-table-body');
                    tbody.innerHTML = result.users.map(user => `
                        <tr>
                            <td>${user.username}</td>
                            <td>${user.email || '-'}</td>
                            <td><span class="badge bg-${user.role === 'admin' ? 'danger' : (user.role === 'operator' ? 'warning' : 'info')}">${user.role}</span></td>
                            <td>${user.totp_enabled ? '<i class="bi bi-shield-check text-success"></i> Yes' : '<i class="bi bi-x-circle text-muted"></i> No'}</td>
                            <td>${user.last_login ? new Date(user.last_login).toLocaleString() : 'Never'}</td>
                            <td>
                                ${user.is_active ? `
                                    <button class="btn btn-sm btn-danger" onclick="deactivateUser(${user.id}, '${user.username}')">
                                        <i class="bi bi-trash"></i> Deactivate
                                    </button>
                                ` : '<span class="text-muted">Inactive</span>'}
                            </td>
                        </tr>
                    `).join('');
                } else {
                    document.getElementById('users-table-body').innerHTML = `
                        <tr><td colspan="6" class="text-center text-danger">Failed to load users</td></tr>
                    `;
                }
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('users-table-body').innerHTML = `
                    <tr><td colspan="6" class="text-center text-danger">Network error</td></tr>
                `;
            }
        }

        // Show create user form
        function showCreateUserForm() {
            const modal = new bootstrap.Modal(document.getElementById('createUserModal'));
            modal.show();
        }

        // Create new user
        async function createUser() {
            const username = document.getElementById('create-username').value.trim();
            const email = document.getElementById('create-email').value.trim();
            const password = document.getElementById('create-password').value;
            const role = document.getElementById('create-role').value;
            const enable2fa = document.getElementById('create-enable-2fa').checked;

            if (!username || !password) {
                alert('Username and password are required.');
                return;
            }

            if (password.length < 12) {
                alert('Password must be at least 12 characters.');
                return;
            }

            try {
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username,
                        email: email || null,
                        password,
                        role,
                        enable_2fa: enable2fa
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert(`User '${username}' created successfully!`);
                    bootstrap.Modal.getInstance(document.getElementById('createUserModal')).hide();
                    document.getElementById('create-username').value = '';
                    document.getElementById('create-email').value = '';
                    document.getElementById('create-password').value = '';
                    showUserManagement(); // Refresh list
                } else {
                    alert('Failed to create user: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error creating user:', error);
                alert('Network error while creating user.');
            }
        }

        // Deactivate user
        async function deactivateUser(userId, username) {
            if (!confirm(`Are you sure you want to deactivate user '${username}'?`)) return;

            try {
                const response = await fetch(`/api/users/${userId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    alert(`User '${username}' deactivated successfully.`);
                    showUserManagement(); // Refresh list
                } else {
                    alert('Failed to deactivate user: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deactivating user:', error);
                alert('Network error while deactivating user.');
            }
        }
    </script>

    <!-- Custom JS - Load last with defer -->
    <script src="{{ url_for('static', filename='js/dashboard.js') }}?v=3" defer></script>
    <script src="{{ url_for('static', filename='js/config-management.js') }}?v=3" defer></script>
    <script src="{{ url_for('static', filename='js/device-classification.js') }}?v=10" defer></script>

    <!-- Hide loading overlay when DOM is ready -->
    <script>
        window.addEventListener('load', function() {
            setTimeout(function() {
                document.getElementById('loading-overlay').classList.add('hide');
            }, 300);
        });
    </script>

</body>
</html>
