<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=5.0">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Network Monitor - Security Dashboard</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">

    <style>
        /* Loading overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.3s ease-out;
        }
        #loading-overlay.hide {
            opacity: 0;
            pointer-events: none;
            display: none;
        }
        .loading-spinner {
            text-align: center;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
            border-width: 0.3rem;
        }
    </style>
</head>
<body class="bg-dark text-light">

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="loading-spinner">
            <div class="spinner-border text-success" role="status"></div>
            <div class="text-light mt-3" id="loading-message">Loading Security Dashboard...</div>
            <div class="text-muted mt-2" style="font-size: 0.85rem;" id="loading-hint">
                Initializing components...
            </div>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-dark bg-black border-bottom border-secondary">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="bi bi-shield-check text-success"></i>
                Network Monitor - Security Dashboard
            </span>
            <div class="d-flex align-items-center">
                <span class="badge bg-success me-3" id="connection-status">
                    <i class="bi bi-wifi"></i> Connected
                </span>
                <span class="text-muted me-3" id="current-time"></span>

                <!-- User Menu -->
                <div class="dropdown">
                    <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" id="userMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-person-circle"></i>
                        <span id="user-display-name">{{ user.username if user else 'User' }}</span>
                        <span class="badge bg-primary ms-1" id="user-role-badge">{{ user.role if user else 'operator' }}</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end dropdown-menu-dark" aria-labelledby="userMenuButton">
                        <li>
                            <h6 class="dropdown-header">
                                <i class="bi bi-person"></i> {{ user.username if user else 'User' }}
                            </h6>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item" href="#" onclick="showUserProfile(); return false;">
                                <i class="bi bi-person-gear"></i> Profile Settings
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="#" onclick="show2FASetup(); return false;">
                                <i class="bi bi-shield-lock"></i> Two-Factor Auth
                            </a>
                        </li>
                        {% if user and user.role == 'admin' %}
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item" href="#" onclick="showUserManagement(); return false;">
                                <i class="bi bi-people"></i> User Management
                            </a>
                        </li>
                        {% endif %}
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item text-danger" href="#" onclick="logout(); return false;">
                                <i class="bi bi-box-arrow-right"></i> Logout
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-3">

        <!-- System Stats Row -->
        <div class="row mb-4">
            <!-- Packets/sec Gauge -->
            <div class="col-md-3">
                <div class="card bg-secondary text-white h-100">
                    <div class="card-body text-center">
                        <h6 class="card-title"><i class="bi bi-activity"></i> Packets/sec</h6>
                        <canvas id="packetsGauge" height="150"></canvas>
                        <h3 class="mt-2" id="packets-value">0</h3>
                    </div>
                </div>
            </div>

            <!-- Alerts/min Gauge -->
            <div class="col-md-3">
                <div class="card bg-secondary text-white h-100">
                    <div class="card-body text-center">
                        <h6 class="card-title"><i class="bi bi-exclamation-triangle"></i> Alerts/min</h6>
                        <canvas id="alertsGauge" height="150"></canvas>
                        <h3 class="mt-2" id="alerts-value">0</h3>
                    </div>
                </div>
            </div>

            <!-- CPU Usage -->
            <div class="col-md-3">
                <div class="card bg-secondary text-white h-100">
                    <div class="card-body text-center">
                        <h6 class="card-title"><i class="bi bi-cpu"></i> CPU Usage</h6>
                        <canvas id="cpuGauge" height="150"></canvas>
                        <h3 class="mt-2" id="cpu-value">0%</h3>
                    </div>
                </div>
            </div>

            <!-- Memory Usage -->
            <div class="col-md-3">
                <div class="card bg-secondary text-white h-100">
                    <div class="card-body text-center">
                        <h6 class="card-title"><i class="bi bi-memory"></i> Memory Usage</h6>
                        <canvas id="memoryGauge" height="150"></canvas>
                        <h3 class="mt-2" id="memory-value">0%</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Remote Sensors Row -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card bg-secondary">
                    <div class="card-header d-flex justify-content-between align-items-center" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#sensorsCollapse">
                        <h5 class="mb-0">
                            <i class="bi bi-broadcast"></i> Remote Sensors
                            <span class="badge bg-info ms-2" id="sensors-count">0</span>
                            <span class="badge bg-success ms-1" id="sensors-online">0</span>
                        </h5>
                        <i class="bi bi-chevron-down"></i>
                    </div>
                    <div class="collapse show" id="sensorsCollapse">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-dark table-sm table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <th>Status</th>
                                            <th>Sensor</th>
                                            <th>Location</th>
                                            <th>CPU</th>
                                            <th>RAM</th>
                                            <th>Bandwidth</th>
                                            <th>Packets</th>
                                            <th>Alerts (24h)</th>
                                            <th>Last Seen</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="sensors-table">
                                        <tr>
                                            <td colspan="10" class="text-center text-muted">Loading sensors...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sensor Command Center Row -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card bg-secondary">
                    <div class="card-header d-flex justify-content-between align-items-center" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#commandsCollapse">
                        <h5 class="mb-0">
                            <i class="bi bi-terminal"></i> Sensor Command Center
                        </h5>
                        <i class="bi bi-chevron-down"></i>
                    </div>
                    <div class="collapse" id="commandsCollapse">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label for="command-sensor-select" class="form-label">Select Sensor</label>
                                    <select class="form-select bg-dark text-light border-secondary" id="command-sensor-select">
                                        <option value="">-- Select Sensor --</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="command-type-select" class="form-label">Command</label>
                                    <select class="form-select bg-dark text-light border-secondary" id="command-type-select">
                                        <option value="">-- Select Command --</option>
                                        <option value="get_status">Get Status</option>
                                        <option value="flush_buffer">Flush Alert Buffer</option>
                                        <option value="change_interval">Change Batch Interval</option>
                                        <option value="restart">Restart Sensor</option>
                                    </select>
                                </div>
                                <div class="col-md-4" id="command-params-container" style="display: none;">
                                    <label for="command-params" class="form-label">Parameters (JSON)</label>
                                    <input type="text" class="form-control bg-dark text-light border-secondary" id="command-params" placeholder='{"interval": 60}'>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <button class="btn btn-primary" id="send-command-btn">
                                        <i class="bi bi-send"></i> Send Command
                                    </button>
                                    <button class="btn btn-secondary ms-2" id="command-history-btn">
                                        <i class="bi bi-clock-history"></i> View History
                                    </button>
                                </div>
                            </div>
                            <div id="command-result" class="mt-3" style="display: none;">
                                <div class="alert" role="alert"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- IP Whitelist Management Row -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card bg-secondary">
                    <div class="card-header d-flex justify-content-between align-items-center" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#whitelistCollapse">
                        <h5 class="mb-0">
                            <i class="bi bi-shield-check"></i> IP Whitelist Management
                            <span class="badge bg-info ms-2" id="whitelist-count">0</span>
                        </h5>
                        <i class="bi bi-chevron-down"></i>
                    </div>
                    <div class="collapse" id="whitelistCollapse">
                        <div class="card-body">
                            <!-- Add Whitelist Form -->
                            <div class="row g-3 mb-3">
                                <div class="col-md-3">
                                    <label for="whitelist-ip" class="form-label">IP / CIDR</label>
                                    <input type="text" class="form-control bg-dark text-light border-secondary" id="whitelist-ip" placeholder="192.168.1.0/24">
                                </div>
                                <div class="col-md-3">
                                    <label for="whitelist-description" class="form-label">Description</label>
                                    <input type="text" class="form-control bg-dark text-light border-secondary" id="whitelist-description" placeholder="Internal network">
                                </div>
                                <div class="col-md-2">
                                    <label for="whitelist-scope" class="form-label">Scope</label>
                                    <select class="form-select bg-dark text-light border-secondary" id="whitelist-scope">
                                        <option value="global">Global</option>
                                        <option value="sensor">Sensor-Specific</option>
                                    </select>
                                </div>
                                <div class="col-md-2" id="whitelist-sensor-container" style="display: none;">
                                    <label for="whitelist-sensor-select" class="form-label">Sensor</label>
                                    <select class="form-select bg-dark text-light border-secondary" id="whitelist-sensor-select">
                                        <option value="">-- Select Sensor --</option>
                                    </select>
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button class="btn btn-success w-100" id="add-whitelist-btn">
                                        <i class="bi bi-plus-circle"></i> Add
                                    </button>
                                </div>
                            </div>
                            <!-- Whitelist Table -->
                            <div class="table-responsive">
                                <table class="table table-dark table-sm table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <th>IP / CIDR</th>
                                            <th>Description</th>
                                            <th>Scope</th>
                                            <th>Sensor</th>
                                            <th>Created</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="whitelist-table">
                                        <tr>
                                            <td colspan="6" class="text-center text-muted">Loading whitelist...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Configuration Management Row -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card bg-secondary">
                    <div class="card-header d-flex justify-content-between align-items-center" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#configCollapse">
                        <h5 class="mb-0">
                            <i class="bi bi-sliders"></i> Configuration Management
                            <span class="badge bg-info ms-2" id="config-params-count">0</span>
                        </h5>
                        <div class="d-flex align-items-center">
                            <button class="btn btn-sm btn-outline-warning me-2" id="reset-config-btn" title="Reset to best practice defaults">
                                <i class="bi bi-arrow-counterclockwise"></i> Reset to Defaults
                            </button>
                            <i class="bi bi-chevron-down"></i>
                        </div>
                    </div>
                    <div class="collapse" id="configCollapse">
                        <div class="card-body">
                            <!-- Sensor Scope Selector -->
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="config-scope-select" class="form-label">
                                        <i class="bi bi-funnel"></i> Configuration Scope
                                    </label>
                                    <select class="form-select bg-dark text-light border-secondary" id="config-scope-select">
                                        <option value="global">Global (All Sensors)</option>
                                        <option value="sensor">Sensor-Specific</option>
                                    </select>
                                </div>
                                <div class="col-md-4" id="config-sensor-container" style="display: none;">
                                    <label for="config-sensor-select" class="form-label">Select Sensor</label>
                                    <select class="form-select bg-dark text-light border-secondary" id="config-sensor-select">
                                        <option value="">-- Select Sensor --</option>
                                    </select>
                                </div>
                                <div class="col-md-4 d-flex align-items-end">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="config-show-defaults" checked>
                                        <label class="form-check-label" for="config-show-defaults">
                                            Show example values
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Category Tabs -->
                            <ul class="nav nav-tabs mb-3" id="configTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="detection-rules-tab" data-bs-toggle="tab" data-bs-target="#detection-rules-pane" type="button" role="tab">
                                        <i class="bi bi-shield-check"></i> Detection Rules
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="thresholds-tab" data-bs-toggle="tab" data-bs-target="#thresholds-pane" type="button" role="tab">
                                        <i class="bi bi-speedometer"></i> Thresholds
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="alerts-config-tab" data-bs-toggle="tab" data-bs-target="#alerts-config-pane" type="button" role="tab">
                                        <i class="bi bi-bell"></i> Alert Management
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="performance-tab" data-bs-toggle="tab" data-bs-target="#performance-pane" type="button" role="tab">
                                        <i class="bi bi-lightning"></i> Performance
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="all-params-tab" data-bs-toggle="tab" data-bs-target="#all-params-pane" type="button" role="tab">
                                        <i class="bi bi-list-ul"></i> All Parameters
                                    </button>
                                </li>
                            </ul>

                            <!-- Tab Content -->
                            <div class="tab-content" id="configTabContent">
                                <!-- Detection Rules Tab -->
                                <div class="tab-pane fade show active" id="detection-rules-pane" role="tabpanel">
                                    <div id="detection-rules-content" class="config-category-content">
                                        <div class="text-center text-muted p-4">
                                            <div class="spinner-border spinner-border-sm" role="status"></div>
                                            <p class="mt-2">Loading detection rules...</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Thresholds Tab -->
                                <div class="tab-pane fade" id="thresholds-pane" role="tabpanel">
                                    <div id="thresholds-content" class="config-category-content">
                                        <div class="text-center text-muted p-4">Loading thresholds...</div>
                                    </div>
                                </div>

                                <!-- Alert Management Tab -->
                                <div class="tab-pane fade" id="alerts-config-pane" role="tabpanel">
                                    <div id="alerts-config-content" class="config-category-content">
                                        <div class="text-center text-muted p-4">Loading alert settings...</div>
                                    </div>
                                </div>

                                <!-- Performance Tab -->
                                <div class="tab-pane fade" id="performance-pane" role="tabpanel">
                                    <div id="performance-content" class="config-category-content">
                                        <div class="text-center text-muted p-4">Loading performance settings...</div>
                                    </div>
                                </div>

                                <!-- All Parameters Tab -->
                                <div class="tab-pane fade" id="all-params-pane" role="tabpanel">
                                    <div id="all-params-content" class="config-category-content">
                                        <div class="text-center text-muted p-4">Loading all parameters...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Traffic Stats Row -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card bg-secondary h-100">
                    <div class="card-header">
                        <h5><i class="bi bi-graph-up"></i> Traffic Volume (24h)</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="trafficChart" height="200"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card bg-secondary h-100">
                    <div class="card-header">
                        <h5><i class="bi bi-pie-chart"></i> Alert Distribution</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="alertPieChart" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Row -->
        <div class="row">
            <!-- Recent Alerts -->
            <div class="col-lg-6 col-md-12 mb-3">
                <div class="card bg-secondary h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="bi bi-bell"></i> Recent Alerts</h5>
                        <span class="badge bg-danger" id="alert-count">0</span>
                    </div>
                    <div class="card-body p-0">
                        <div class="alert-feed" id="alert-feed">
                            <div class="text-center text-muted p-4">
                                Loading alerts...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top Talkers -->
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card bg-secondary h-100">
                    <div class="card-header">
                        <h5><i class="bi bi-people"></i> Top Talkers</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-dark table-sm table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>IP/Hostname</th>
                                        <th>Traffic</th>
                                        <th>Dir</th>
                                    </tr>
                                </thead>
                                <tbody id="top-talkers-table">
                                    <tr>
                                        <td colspan="3" class="text-center text-muted">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Threat Types -->
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card bg-secondary h-100">
                    <div class="card-header">
                        <h5><i class="bi bi-bug"></i> Threat Types</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="list-group list-group-flush" id="threat-types-list">
                            <div class="list-group-item bg-dark text-muted text-center">
                                Loading...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Alert Details Modal -->
    <div class="modal fade" id="alertDetailsModal" tabindex="-1" aria-labelledby="alertDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header">
                    <h5 class="modal-title" id="alertDetailsModalLabel">
                        <i class="bi bi-info-circle"></i> Alert Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="alertDetailsBody">
                    <!-- Alert details will be populated here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Threat Type Details Modal -->
    <div class="modal fade" id="threatDetailsModal" tabindex="-1" aria-labelledby="threatDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header">
                    <h5 class="modal-title" id="threatDetailsModalLabel">
                        <i class="bi bi-bug-fill"></i> Threat Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="threatDetailsBody">
                    <!-- Loading indicator -->
                    <div id="threatDetailsLoading" class="text-center p-4">
                        <div class="spinner-border text-success" role="status"></div>
                        <div class="text-muted mt-2">Loading threat details...</div>
                    </div>
                    <!-- Threat details will be populated here -->
                    <div id="threatDetailsContent" style="display: none;">
                        <!-- Statistics Cards -->
                        <div class="row mb-4" id="threatStatsRow">
                            <!-- Statistics will be populated here -->
                        </div>

                        <!-- Tabs -->
                        <ul class="nav nav-tabs mb-3" id="threatDetailsTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview-pane" type="button" role="tab">
                                    <i class="bi bi-grid"></i> Overview
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="sources-tab" data-bs-toggle="tab" data-bs-target="#sources-pane" type="button" role="tab">
                                    <i class="bi bi-hdd-network"></i> Source IPs
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="targets-tab" data-bs-toggle="tab" data-bs-target="#targets-pane" type="button" role="tab">
                                    <i class="bi bi-hdd-network-fill"></i> Targets
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="alerts-tab" data-bs-toggle="tab" data-bs-target="#alerts-pane" type="button" role="tab">
                                    <i class="bi bi-list-ul"></i> All Alerts
                                </button>
                            </li>
                        </ul>

                        <!-- Tab Content -->
                        <div class="tab-content" id="threatDetailsTabContent">
                            <!-- Overview Tab -->
                            <div class="tab-pane fade show active" id="overview-pane" role="tabpanel">
                                <div id="threatOverviewContent"></div>
                            </div>

                            <!-- Sources Tab -->
                            <div class="tab-pane fade" id="sources-pane" role="tabpanel">
                                <div class="table-responsive">
                                    <table class="table table-dark table-striped">
                                        <thead>
                                            <tr>
                                                <th>Source IP</th>
                                                <th>Hostname</th>
                                                <th>Country</th>
                                                <th>Count</th>
                                            </tr>
                                        </thead>
                                        <tbody id="threatSourcesTable"></tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Targets Tab -->
                            <div class="tab-pane fade" id="targets-pane" role="tabpanel">
                                <div class="table-responsive">
                                    <table class="table table-dark table-striped">
                                        <thead>
                                            <tr>
                                                <th>Target IP</th>
                                                <th>Hostname</th>
                                                <th>Country</th>
                                                <th>Count</th>
                                            </tr>
                                        </thead>
                                        <tbody id="threatTargetsTable"></tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- All Alerts Tab -->
                            <div class="tab-pane fade" id="alerts-pane" role="tabpanel">
                                <div id="threatAlertsContent"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reset Config Confirmation Modal -->
    <div class="modal fade" id="resetConfigModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle text-warning"></i>
                        Reset Configuration to Defaults
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-warning">
                        <i class="bi bi-exclamation-circle"></i>
                        <strong>Warning:</strong> This will reset all configuration parameters to best practice defaults.
                    </p>
                    <p>This action will:</p>
                    <ul>
                        <li>Reset detection rules to recommended settings</li>
                        <li>Update thresholds to best practice values</li>
                        <li>Configure alert management for optimal performance</li>
                        <li>Apply settings to: <strong id="reset-scope-display">Global (All Sensors)</strong></li>
                    </ul>
                    <p class="text-muted">
                        <i class="bi bi-info-circle"></i>
                        Sensors will automatically sync within 5 minutes. No restart required.
                    </p>
                    <div class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" id="reset-confirm-checkbox">
                        <label class="form-check-label" for="reset-confirm-checkbox">
                            I understand that this will overwrite current settings
                        </label>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" id="confirm-reset-btn" disabled>
                        <i class="bi bi-arrow-counterclockwise"></i> Reset to Defaults
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Sensor Settings Modal -->
    <div class="modal fade" id="editSensorModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">
                        <i class="bi bi-sliders"></i>
                        Edit Sensor Settings
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit-sensor-id">
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="bi bi-hdd-network"></i> Sensor Information
                        </label>
                        <div class="alert alert-secondary">
                            <strong id="edit-sensor-name"></strong><br>
                            <small class="text-muted" id="edit-sensor-id-display"></small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="edit-sensor-location" class="form-label">
                            <i class="bi bi-geo-alt"></i> Sensor Location
                        </label>
                        <input type="text" class="form-control bg-secondary text-light border-secondary"
                               id="edit-sensor-location" placeholder="e.g., Building A - VLAN 10">
                        <small class="form-text text-muted">Physical location or network segment description</small>
                    </div>

                    <div class="mb-3">
                        <label for="edit-internal-networks" class="form-label">
                            <i class="bi bi-diagram-3"></i> Internal Networks (CIDR)
                        </label>
                        <textarea class="form-control bg-secondary text-light border-secondary"
                                  id="edit-internal-networks" rows="3"
                                  placeholder="10.0.0.0/8&#10;172.16.0.0/12&#10;192.168.0.0/16"></textarea>
                        <small class="form-text text-muted">One network per line (e.g., 192.168.1.0/24)</small>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit-heartbeat-interval" class="form-label">
                                <i class="bi bi-heartbeat"></i> Heartbeat Interval (seconds)
                            </label>
                            <input type="number" class="form-control bg-secondary text-light border-secondary"
                                   id="edit-heartbeat-interval" min="10" max="300" value="30">
                            <small class="form-text text-muted">How often sensor sends heartbeat (default: 30s)</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit-config-sync-interval" class="form-label">
                                <i class="bi bi-arrow-repeat"></i> Config Sync Interval (seconds)
                            </label>
                            <input type="number" class="form-control bg-secondary text-light border-secondary"
                                   id="edit-config-sync-interval" min="60" max="3600" value="300">
                            <small class="form-text text-muted">How often sensor syncs config (default: 300s)</small>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Note:</strong> Changes will be picked up automatically within the configured sync interval.
                        To apply immediately, restart the sensor.
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="save-sensor-settings-btn" onclick="saveSensorSettings()">
                        <i class="bi bi-save"></i> Save Settings
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- User Profile Modal -->
    <div class="modal fade" id="userProfileModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">
                        <i class="bi bi-person-gear"></i> Profile Settings
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="profile-username" class="form-label"><i class="bi bi-person"></i> Username</label>
                        <input type="text" class="form-control bg-secondary text-light" id="profile-username" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="profile-email" class="form-label"><i class="bi bi-envelope"></i> Email</label>
                        <input type="email" class="form-control bg-secondary text-light" id="profile-email" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="profile-role" class="form-label"><i class="bi bi-shield-check"></i> Role</label>
                        <input type="text" class="form-control bg-secondary text-light" id="profile-role" readonly>
                    </div>
                    <hr class="border-secondary">
                    <h6><i class="bi bi-key"></i> Change Password</h6>
                    <div class="mb-3">
                        <label for="current-password" class="form-label">Current Password</label>
                        <input type="password" class="form-control bg-secondary text-light border-secondary" id="current-password">
                    </div>
                    <div class="mb-3">
                        <label for="new-password" class="form-label">New Password</label>
                        <input type="password" class="form-control bg-secondary text-light border-secondary" id="new-password">
                        <small class="text-muted">Minimum 12 characters</small>
                    </div>
                    <button class="btn btn-primary" onclick="changePassword()">
                        <i class="bi bi-key"></i> Change Password
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 2FA Setup Modal -->
    <div class="modal fade" id="twoFactorModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">
                        <i class="bi bi-shield-lock"></i> Two-Factor Authentication
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="twoFactorContent">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2">Loading...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Management Modal (Admin Only) -->
    <div class="modal fade" id="userManagementModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">
                        <i class="bi bi-people"></i> User Management
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <button class="btn btn-success" onclick="showCreateUserForm()">
                            <i class="bi bi-plus-circle"></i> Create New User
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-dark table-striped">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>2FA</th>
                                    <th>Last Login</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body">
                                <tr>
                                    <td colspan="6" class="text-center">Loading users...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create User Modal -->
    <div class="modal fade" id="createUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">
                        <i class="bi bi-person-plus"></i> Create New User
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Username *</label>
                        <input type="text" class="form-control bg-secondary text-light border-secondary" id="create-username" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control bg-secondary text-light border-secondary" id="create-email">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Password *</label>
                        <input type="password" class="form-control bg-secondary text-light border-secondary" id="create-password" required>
                        <small class="text-muted">Minimum 12 characters</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Role *</label>
                        <select class="form-select bg-secondary text-light border-secondary" id="create-role">
                            <option value="viewer">Viewer (Read-only)</option>
                            <option value="operator" selected>Operator (Manage sensors & alerts)</option>
                            <option value="admin">Admin (Full access)</option>
                        </select>
                    </div>
                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" id="create-enable-2fa">
                        <label class="form-check-label" for="create-enable-2fa">
                            Enable 2FA (recommended)
                        </label>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createUser()">
                        <i class="bi bi-save"></i> Create User
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- External Libraries -->
    <!-- Bootstrap JS must load first (no defer) for dropdown and modal functionality -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Initialize Bootstrap dropdowns after everything is loaded -->
    <script>
        // Wait for both DOM and window load
        function initializeDropdowns() {
            console.log('[DROPDOWN] Initializing Bootstrap dropdowns...');

            // Find all dropdown toggles
            var dropdownElements = document.querySelectorAll('[data-bs-toggle="dropdown"]');
            console.log('[DROPDOWN] Found dropdown elements:', dropdownElements.length);

            if (dropdownElements.length === 0) {
                console.warn('[DROPDOWN] No dropdown elements found!');
                return;
            }

            // Initialize each dropdown
            dropdownElements.forEach(function(element) {
                try {
                    // Check if already initialized
                    var dropdown = bootstrap.Dropdown.getInstance(element);
                    if (!dropdown) {
                        dropdown = new bootstrap.Dropdown(element);
                        console.log('[DROPDOWN] Initialized:', element.id || element.className);
                    } else {
                        console.log('[DROPDOWN] Already initialized:', element.id || element.className);
                    }
                } catch (e) {
                    console.error('[DROPDOWN] Error initializing dropdown:', e);
                }
            });

            console.log('[DROPDOWN] Initialization complete');
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeDropdowns);
        } else {
            // DOM already loaded
            initializeDropdowns();
        }

        // Re-initialize after loading overlay is hidden (to ensure it's clickable)
        window.addEventListener('load', function() {
            setTimeout(initializeDropdowns, 500);
        });
    </script>

    <!-- Other libraries can load asynchronously -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" defer></script>
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js" defer></script>

    <!-- Authentication & User Management Script -->
    <script>
        // Logout function
        async function logout() {
            if (!confirm('Are you sure you want to logout?')) return;

            try {
                const response = await fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    window.location.href = '/login';
                } else {
                    alert('Logout failed. Please try again.');
                }
            } catch (error) {
                console.error('Logout error:', error);
                alert('Network error during logout.');
            }
        }

        // Show user profile modal
        async function showUserProfile() {
            try {
                const response = await fetch('/api/auth/current-user');
                const result = await response.json();

                if (result.success) {
                    const user = result.user;
                    document.getElementById('profile-username').value = user.username || '';
                    document.getElementById('profile-email').value = user.email || '';
                    document.getElementById('profile-role').value = user.role || '';

                    const modal = new bootstrap.Modal(document.getElementById('userProfileModal'));
                    modal.show();
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
                alert('Failed to load user profile.');
            }
        }

        // Change password
        async function changePassword() {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;

            if (!currentPassword || !newPassword) {
                alert('Please enter both current and new password.');
                return;
            }

            if (newPassword.length < 12) {
                alert('New password must be at least 12 characters.');
                return;
            }

            try {
                const response = await fetch('/api/auth/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        old_password: currentPassword,
                        new_password: newPassword
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert('Password changed successfully!');
                    document.getElementById('current-password').value = '';
                    document.getElementById('new-password').value = '';
                    bootstrap.Modal.getInstance(document.getElementById('userProfileModal')).hide();
                } else {
                    alert(result.error || 'Failed to change password.');
                }
            } catch (error) {
                console.error('Error changing password:', error);
                alert('Network error while changing password.');
            }
        }

        // Show 2FA setup modal
        async function show2FASetup() {
            const modal = new bootstrap.Modal(document.getElementById('twoFactorModal'));
            modal.show();

            // Load current 2FA status
            try {
                const response = await fetch('/api/auth/current-user');
                const result = await response.json();

                if (result.success) {
                    const user = result.user;
                    const content = document.getElementById('twoFactorContent');

                    if (user.totp_enabled) {
                        // 2FA is enabled
                        content.innerHTML = `
                            <div class="alert alert-success">
                                <i class="bi bi-shield-check"></i>
                                <strong>Two-Factor Authentication is ENABLED</strong>
                                <p class="mb-0 mt-2">Your account is protected with 2FA.</p>
                            </div>
                            <button class="btn btn-danger" onclick="disable2FA()">
                                <i class="bi bi-x-circle"></i> Disable 2FA
                            </button>
                        `;
                    } else {
                        // 2FA is not enabled - show setup
                        content.innerHTML = `
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i>
                                <strong>Two-Factor Authentication is DISABLED</strong>
                                <p class="mb-0 mt-2">Enable 2FA to add an extra layer of security to your account.</p>
                            </div>
                            <button class="btn btn-success" onclick="enable2FA()">
                                <i class="bi bi-shield-plus"></i> Enable 2FA
                            </button>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error loading 2FA status:', error);
                document.getElementById('twoFactorContent').innerHTML = `
                    <div class="alert alert-danger">Error loading 2FA status.</div>
                `;
            }
        }

        // Enable 2FA
        async function enable2FA() {
            try {
                const response = await fetch('/api/auth/setup-2fa', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (result.success) {
                    // Show QR code and backup codes
                    const content = document.getElementById('twoFactorContent');
                    content.innerHTML = `
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle"></i>
                            <strong>2FA Enabled Successfully!</strong>
                        </div>
                        <div class="text-center mb-4">
                            <p>Scan this QR code with your authenticator app:</p>
                            <img src="data:image/png;base64,${result.qr_code}" alt="QR Code" class="img-fluid" style="max-width: 300px;">
                            <p class="mt-2 text-muted">Secret: <code>${result.secret}</code></p>
                        </div>
                        <div class="alert alert-warning">
                            <strong><i class="bi bi-key"></i> Backup Codes (Save these!)</strong>
                            <p class="mb-2">Use these codes if you lose access to your authenticator:</p>
                            <div class="row">
                                ${result.backup_codes.map((code, i) => `
                                    <div class="col-6 mb-1"><code>${code}</code></div>
                                `).join('')}
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="show2FASetup()">
                            <i class="bi bi-check"></i> Done
                        </button>
                    `;
                } else {
                    alert('Failed to enable 2FA: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error enabling 2FA:', error);
                alert('Network error while enabling 2FA.');
            }
        }

        // Disable 2FA
        async function disable2FA() {
            if (!confirm('Are you sure you want to disable Two-Factor Authentication?')) return;

            try {
                const response = await fetch('/api/auth/disable-2fa', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (result.success) {
                    alert('2FA disabled successfully.');
                    show2FASetup(); // Refresh modal
                } else {
                    alert('Failed to disable 2FA: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error disabling 2FA:', error);
                alert('Network error while disabling 2FA.');
            }
        }

        // Show user management modal (admin only)
        async function showUserManagement() {
            const modal = new bootstrap.Modal(document.getElementById('userManagementModal'));
            modal.show();

            // Load users
            try {
                const response = await fetch('/api/users');
                const result = await response.json();

                if (result.success) {
                    const tbody = document.getElementById('users-table-body');
                    tbody.innerHTML = result.users.map(user => `
                        <tr>
                            <td>${user.username}</td>
                            <td>${user.email || '-'}</td>
                            <td><span class="badge bg-${user.role === 'admin' ? 'danger' : (user.role === 'operator' ? 'warning' : 'info')}">${user.role}</span></td>
                            <td>${user.totp_enabled ? '<i class="bi bi-shield-check text-success"></i> Yes' : '<i class="bi bi-x-circle text-muted"></i> No'}</td>
                            <td>${user.last_login ? new Date(user.last_login).toLocaleString() : 'Never'}</td>
                            <td>
                                ${user.is_active ? `
                                    <button class="btn btn-sm btn-danger" onclick="deactivateUser(${user.id}, '${user.username}')">
                                        <i class="bi bi-trash"></i> Deactivate
                                    </button>
                                ` : '<span class="text-muted">Inactive</span>'}
                            </td>
                        </tr>
                    `).join('');
                } else {
                    document.getElementById('users-table-body').innerHTML = `
                        <tr><td colspan="6" class="text-center text-danger">Failed to load users</td></tr>
                    `;
                }
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('users-table-body').innerHTML = `
                    <tr><td colspan="6" class="text-center text-danger">Network error</td></tr>
                `;
            }
        }

        // Show create user form
        function showCreateUserForm() {
            const modal = new bootstrap.Modal(document.getElementById('createUserModal'));
            modal.show();
        }

        // Create new user
        async function createUser() {
            const username = document.getElementById('create-username').value.trim();
            const email = document.getElementById('create-email').value.trim();
            const password = document.getElementById('create-password').value;
            const role = document.getElementById('create-role').value;
            const enable2fa = document.getElementById('create-enable-2fa').checked;

            if (!username || !password) {
                alert('Username and password are required.');
                return;
            }

            if (password.length < 12) {
                alert('Password must be at least 12 characters.');
                return;
            }

            try {
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username,
                        email: email || null,
                        password,
                        role,
                        enable_2fa: enable2fa
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert(`User '${username}' created successfully!`);
                    bootstrap.Modal.getInstance(document.getElementById('createUserModal')).hide();
                    document.getElementById('create-username').value = '';
                    document.getElementById('create-email').value = '';
                    document.getElementById('create-password').value = '';
                    showUserManagement(); // Refresh list
                } else {
                    alert('Failed to create user: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error creating user:', error);
                alert('Network error while creating user.');
            }
        }

        // Deactivate user
        async function deactivateUser(userId, username) {
            if (!confirm(`Are you sure you want to deactivate user '${username}'?`)) return;

            try {
                const response = await fetch(`/api/users/${userId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    alert(`User '${username}' deactivated successfully.`);
                    showUserManagement(); // Refresh list
                } else {
                    alert('Failed to deactivate user: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deactivating user:', error);
                alert('Network error while deactivating user.');
            }
        }
    </script>

    <!-- Custom JS - Load last with defer -->
    <script src="{{ url_for('static', filename='js/dashboard.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/config-management.js') }}" defer></script>

    <!-- Hide loading overlay when DOM is ready -->
    <script>
        window.addEventListener('load', function() {
            setTimeout(function() {
                document.getElementById('loading-overlay').classList.add('hide');
            }, 300);
        });
    </script>

</body>
</html>
